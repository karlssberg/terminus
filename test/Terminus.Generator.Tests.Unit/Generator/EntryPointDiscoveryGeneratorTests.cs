using System.Text;
using Microsoft.CodeAnalysis.Text;
using Terminus.Generator.Tests.Unit.Generator.Infrastructure;

namespace Terminus.Generator.Tests.Unit.Generator;

public class EntryPointDiscoveryGeneratorTests
{
    [Fact]
    public async Task Given_a_single_parameter_method_Should_generate_entry_point_command()
    {
        const string source =
            """
            using Terminus.Attributes;
            using System;

            namespace Demo
            {
                [AutoGenerate]
                public partial interface IMediator;
                
                public static class TestEntryPoints
                {
                    [EntryPoint]
                    public static void Hello(string world) 
                    { 
                        Console.WriteLine($"hello {world}"); 
                    }
                }
            }
            """;

        const string expectedMainSource =
            """
            // <auto-generated/> Generated by Terminus EntryPointDiscoveryGenerator
            #nullable enable
            using Microsoft.Extensions.DependencyInjection;
            using System;
            using System.Reflection;
            using Terminus;
            using Terminus.Attributes;
            using Terminus.Strategies;
            
            namespace Demo
            {
                public partial interface IMediator
                {
                    void Hello(string world);
                }
            
                internal sealed class IMediator_Generated : Demo.IMediator
                {
                    private readonly IServiceProvider _serviceProvider;
                    public IMediator_Generated(IServiceProvider serviceProvider)
                    {
                        _serviceProvider = serviceProvider;
                    }
            
                    public void Hello(string world)
                    {
                        using (var scope = _serviceProvider.CreateScope())
                        {
                            Demo.TestEntryPoints.Hello(world);
                        }
                    }
                }
            }
            
            namespace Terminus.Generated
            {
                public static partial class ServiceCollectionExtensions
                {
                    private static IServiceCollection AddEntryPointsFor_Terminus_Attributes_EntryPointAttribute(this IServiceCollection services, Action<ParameterBindingStrategyResolver>? configure = null)
                    {
                        var resolver = new ParameterBindingStrategyResolver();
                        configure?.Invoke(resolver);
                        services.AddSingleton(resolver);
                        services.AddTransient<IDispatcher<Terminus.Attributes.EntryPointAttribute>, ScopedDispatcher<Terminus.Attributes.EntryPointAttribute>>();
                        services.AddTransient<IAsyncDispatcher<Terminus.Attributes.EntryPointAttribute>, ScopedDispatcher<Terminus.Attributes.EntryPointAttribute>>();
                        services.AddTransient<IEntryPointRouter<Terminus.Attributes.EntryPointAttribute>, DefaultEntryPointRouter<Terminus.Attributes.EntryPointAttribute>>();
                        services.AddSingleton<EntryPointDescriptor<Terminus.Attributes.EntryPointAttribute>>(new EntryPointDescriptor<Terminus.Attributes.EntryPointAttribute>(typeof(Demo.TestEntryPoints).GetMethod("Hello", new System.Type[] { typeof(string) })!, (context, ct) => Demo.TestEntryPoints.Hello(resolver.ResolveParameter<string>("world", context))));
                        services.AddSingleton<Demo.IMediator, Demo.IMediator_Generated>();
                        return services;
                    }
                }
            }
            """;

        const string expectedServiceRegistrationSource =
            """
            #nullable enable
            using Microsoft.Extensions.DependencyInjection;
            using System;
            using Terminus.Attributes;
            
            namespace Terminus.Generated
            {
                public static partial class ServiceCollectionExtensions
                {
                    public static IServiceCollection AddEntryPoints<T>(this IServiceCollection services, Action<ParameterBindingStrategyResolver>? configure = null)
                        where T : EntryPointAttribute
                    {
                        switch (typeof(T).FullName)
                        {
                            case "Terminus.Attributes.EntryPointAttribute":
                                return services.AddEntryPointsFor_Terminus_Attributes_EntryPointAttribute(configure);
                        };
                        throw new InvalidOperationException($"No entry point discovery strategy found for type '{typeof(T).FullName}'");
                    }

                    public static IServiceCollection AddEntryPoints(this IServiceCollection services, Action<ParameterBindingStrategyResolver>? configure = null)
                    {
                        services.AddEntryPointsFor_Terminus_Attributes_EntryPointAttribute();
                        return services;
                    }
                }
            }
            """;

    var test = new TerminusSourceGeneratorTest<EntryPointDiscoveryGenerator>
        {
            TestState =
            {
                Sources = { source }
            }
        };

        test.TestState.GeneratedSources.Add((
            typeof(EntryPointDiscoveryGenerator), 
            "Terminus_Attributes_EntryPointAttribute_Generated.g.cs", 
            SourceText.From(expectedMainSource, Encoding.UTF8)));
        
        test.TestState.GeneratedSources.Add((
            typeof(EntryPointDiscoveryGenerator), 
            "__EntryPointServiceRegistration_Generated.g.cs",
            SourceText.From(expectedServiceRegistrationSource, Encoding.UTF8)));

        await test.RunAsync();
    }
    
    [Fact]
    public async Task Given_a_static_target_containing_type_Should_not_generate_service_registration()
    {
        const string source =
            """
            using Terminus.Attributes;
            using System;

            namespace Demo
            {
                [AutoGenerate]
                public partial interface IMediator;
                
                public static class TestEntryPoints
                {
                    [EntryPoint]
                    public static void Hello(string world) 
                    { 
                        Console.WriteLine($"hello {world}"); 
                    }
                }
            }
            """;

        const string expectedMainSource =
            """
            // <auto-generated/> Generated by Terminus EntryPointDiscoveryGenerator
            #nullable enable
            using Microsoft.Extensions.DependencyInjection;
            using System;
            using System.Reflection;
            using Terminus;
            using Terminus.Attributes;
            using Terminus.Strategies;
            
            namespace Demo
            {
                public partial interface IMediator
                {
                    void Hello(string world);
                }
            
                internal sealed class IMediator_Generated : Demo.IMediator
                {
                    private readonly IServiceProvider _serviceProvider;
                    public IMediator_Generated(IServiceProvider serviceProvider)
                    {
                        _serviceProvider = serviceProvider;
                    }
            
                    public void Hello(string world)
                    {
                        using (var scope = _serviceProvider.CreateScope())
                        {
                            Demo.TestEntryPoints.Hello(world);
                        }
                    }
                }
            }
            
            namespace Terminus.Generated
            {
                public static partial class ServiceCollectionExtensions
                {
                    private static IServiceCollection AddEntryPointsFor_Terminus_Attributes_EntryPointAttribute(this IServiceCollection services, Action<ParameterBindingStrategyResolver>? configure = null)
                    {
                        var resolver = new ParameterBindingStrategyResolver();
                        configure?.Invoke(resolver);
                        services.AddSingleton(resolver);
                        services.AddTransient<IDispatcher<Terminus.Attributes.EntryPointAttribute>, ScopedDispatcher<Terminus.Attributes.EntryPointAttribute>>();
                        services.AddTransient<IAsyncDispatcher<Terminus.Attributes.EntryPointAttribute>, ScopedDispatcher<Terminus.Attributes.EntryPointAttribute>>();
                        services.AddTransient<IEntryPointRouter<Terminus.Attributes.EntryPointAttribute>, DefaultEntryPointRouter<Terminus.Attributes.EntryPointAttribute>>();
                        services.AddSingleton<EntryPointDescriptor<Terminus.Attributes.EntryPointAttribute>>(new EntryPointDescriptor<Terminus.Attributes.EntryPointAttribute>(typeof(Demo.TestEntryPoints).GetMethod("Hello", new System.Type[] { typeof(string) })!, (context, ct) => Demo.TestEntryPoints.Hello(resolver.ResolveParameter<string>("world", context))));
                        services.AddSingleton<Demo.IMediator, Demo.IMediator_Generated>();
                        return services;
                    }
                }
            }
            """;

        const string expectedServiceRegistrationSource =
            """
            #nullable enable
            using Microsoft.Extensions.DependencyInjection;
            using System;
            using Terminus.Attributes;
            
            namespace Terminus.Generated
            {
                public static partial class ServiceCollectionExtensions
                {
                    public static IServiceCollection AddEntryPoints<T>(this IServiceCollection services, Action<ParameterBindingStrategyResolver>? configure = null)
                        where T : EntryPointAttribute
                    {
                        switch (typeof(T).FullName)
                        {
                            case "Terminus.Attributes.EntryPointAttribute":
                                return services.AddEntryPointsFor_Terminus_Attributes_EntryPointAttribute(configure);
                        };
                        throw new InvalidOperationException($"No entry point discovery strategy found for type '{typeof(T).FullName}'");
                    }
            
                    public static IServiceCollection AddEntryPoints(this IServiceCollection services, Action<ParameterBindingStrategyResolver>? configure = null)
                    {
                        services.AddEntryPointsFor_Terminus_Attributes_EntryPointAttribute();
                        return services;
                    }
                }
            }
            """;

    var test = new TerminusSourceGeneratorTest<EntryPointDiscoveryGenerator>
        {
            TestState =
            {
                Sources = { source }
            }
        };

        test.TestState.GeneratedSources.Add((
            typeof(EntryPointDiscoveryGenerator), 
            "Terminus_Attributes_EntryPointAttribute_Generated.g.cs", 
            SourceText.From(expectedMainSource, Encoding.UTF8)));
        
        test.TestState.GeneratedSources.Add((
            typeof(EntryPointDiscoveryGenerator), 
            "__EntryPointServiceRegistration_Generated.g.cs",
            SourceText.From(expectedServiceRegistrationSource, Encoding.UTF8)));

        await test.RunAsync();
    }
   
    [Fact]
    public async Task Given_a_parameterless_method_Should_generate_entry_point_command()
    {
        const string source =
            """
            using Terminus.Attributes;
            using System;
            using System.Threading.Tasks;

            namespace Demo
            {
                [AutoGenerate]
                public partial interface IMediator;
                
                public class TestEntryPoints
                {
                    [EntryPoint]
                    public Task Hello() 
                    { 
                        return Task.CompletedTask;
                    }
                }
            }
            """;

        const string expectedMainSource =
            $$"""
              // <auto-generated/> Generated by Terminus EntryPointDiscoveryGenerator
              #nullable enable
              using Microsoft.Extensions.DependencyInjection;
              using System;
              using System.Reflection;
              using Terminus;
              using Terminus.Attributes;
              using Terminus.Strategies;
              
              namespace Demo
              {
                  public partial interface IMediator
                  {
                      System.Threading.Tasks.Task Hello();
                  }
              
                  internal sealed class IMediator_Generated : Demo.IMediator
                  {
                      private readonly IServiceProvider _serviceProvider;
                      public IMediator_Generated(IServiceProvider serviceProvider)
                      {
                          _serviceProvider = serviceProvider;
                      }
              
                      public System.Threading.Tasks.Task Hello()
                      {
                          using (var scope = _serviceProvider.CreateScope())
                          {
                              return scope.ServiceProvider.GetRequiredService<Demo.TestEntryPoints>().Hello();
                          }
                      }
                  }
              }
              
              namespace Terminus.Generated
              {
                  public static partial class ServiceCollectionExtensions
                  {
                      private static IServiceCollection AddEntryPointsFor_Terminus_Attributes_EntryPointAttribute(this IServiceCollection services, Action<ParameterBindingStrategyResolver>? configure = null)
                      {
                          var resolver = new ParameterBindingStrategyResolver();
                          configure?.Invoke(resolver);
                          services.AddSingleton(resolver);
                          services.AddTransient<IDispatcher<Terminus.Attributes.EntryPointAttribute>, ScopedDispatcher<Terminus.Attributes.EntryPointAttribute>>();
                          services.AddTransient<IAsyncDispatcher<Terminus.Attributes.EntryPointAttribute>, ScopedDispatcher<Terminus.Attributes.EntryPointAttribute>>();
                          services.AddTransient<IEntryPointRouter<Terminus.Attributes.EntryPointAttribute>, DefaultEntryPointRouter<Terminus.Attributes.EntryPointAttribute>>();
                          services.AddSingleton<EntryPointDescriptor<Terminus.Attributes.EntryPointAttribute>>(new EntryPointDescriptor<Terminus.Attributes.EntryPointAttribute>(typeof(Demo.TestEntryPoints).GetMethod("Hello", new System.Type[] { })!, (context, ct) => context.ServiceProvider.GetRequiredService<Demo.TestEntryPoints>().Hello()));
                          services.AddTransient<Demo.TestEntryPoints>();
                          services.AddSingleton<Demo.IMediator, Demo.IMediator_Generated>();
                          return services;
                      }
                  }
              }
              """;
        
        const string expectedServiceRegistrationSource =
            """
            #nullable enable
            using Microsoft.Extensions.DependencyInjection;
            using System;
            using Terminus.Attributes;

            namespace Terminus.Generated
            {
                public static partial class ServiceCollectionExtensions
                {
                    public static IServiceCollection AddEntryPoints<T>(this IServiceCollection services, Action<ParameterBindingStrategyResolver>? configure = null)
                        where T : EntryPointAttribute
                    {
                        switch (typeof(T).FullName)
                        {
                            case "Terminus.Attributes.EntryPointAttribute":
                                return services.AddEntryPointsFor_Terminus_Attributes_EntryPointAttribute(configure);
                        };
                        throw new InvalidOperationException($"No entry point discovery strategy found for type '{typeof(T).FullName}'");
                    }

                    public static IServiceCollection AddEntryPoints(this IServiceCollection services, Action<ParameterBindingStrategyResolver>? configure = null)
                    {
                        services.AddEntryPointsFor_Terminus_Attributes_EntryPointAttribute();
                        return services;
                    }
                }
            }
            """;

    var test = new TerminusSourceGeneratorTest<EntryPointDiscoveryGenerator>
        {
            TestState =
            {
                Sources = { source }
            }
        };

        test.TestState.GeneratedSources.Add((
            typeof(EntryPointDiscoveryGenerator), 
            "Terminus_Attributes_EntryPointAttribute_Generated.g.cs", 
            SourceText.From(expectedMainSource, Encoding.UTF8)));
       
        test.TestState.GeneratedSources.Add((
            typeof(EntryPointDiscoveryGenerator), 
            "__EntryPointServiceRegistration_Generated.g.cs",
            SourceText.From(expectedServiceRegistrationSource, Encoding.UTF8)));
        

        await test.RunAsync();
    }
    
}
