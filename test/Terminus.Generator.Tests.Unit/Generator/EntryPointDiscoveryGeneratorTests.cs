using System.Text;
using Microsoft.CodeAnalysis.Text;
using Terminus.Generator.Tests.Unit.Generator.Infrastructure;

namespace Terminus.Generator.Tests.Unit.Generator;

public class EntryPointDiscoveryGeneratorTests
{
    [Fact]
    public async Task Given_a_single_parameter_method_Should_generate_entry_point_command()
    {
        const string source =
            """
            using Terminus.Attributes;
            using System;

            namespace Demo
            {
                [EntryPointMediator]
                public partial interface IMediator;
                
                public class TestEntryPoints
                {
                    [EntryPoint]
                    public static void Hello(string world) 
                    { 
                        Console.WriteLine($"hello {world}"); 
                    }
                }
            }
            """;

        const string expected =
            """
            // <auto-generated/> Generated by Terminus EntryPointDiscoveryGenerator
            #nullable enable
            using Microsoft.Extensions.DependencyInjection;
            using System;
            using System.Reflection;
            using Terminus;
            using Terminus.Attributes;
            using Terminus.Strategies;
            
            namespace Demo
            {
                public partial interface IMediator
                {
                    void Hello(string world);
                }
            
                internal sealed class IMediator_Generated : Demo.IMediator
                {
                    private readonly IServiceProvider _serviceProvider;
                    private readonly ParameterBindingStrategyResolver _resolver;
                    public IMediator_Generated(IServiceProvider serviceProvider, ParameterBindingStrategyResolver resolver)
                    {
                        _serviceProvider = serviceProvider;
                        _resolver = resolver;
                    }
            
                    public void Hello(string world)
                    {
                        using (var scope = _serviceProvider.CreateScope())
                        {
                            Demo.TestEntryPoints.Hello(world);
                        }
                    }
                }
            }
            
            namespace Terminus.Generated
            {
                public static partial class ServiceCollectionExtensions
                {
                    public static IServiceCollection AddEntryPointsForIMediator(this IServiceCollection services, Action<ParameterBindingStrategyResolver>? configure = null)
                    {
                        var resolver = new ParameterBindingStrategyResolver();
                        configure?.Invoke(resolver);
                        services.AddSingleton(resolver);
                        services.AddSingleton<EntryPointDescriptor<Terminus.Attributes.EntryPointAttribute>>(new EntryPointDescriptor<Terminus.Attributes.EntryPointAttribute>(typeof(Demo.TestEntryPoints).GetMethod("Hello", new System.Type[] { typeof(string) })!, context => Demo.TestEntryPoints.Hello(resolver.ResolveParameter<string>("world", context))));
                        services.AddSingleton<Demo.IMediator, Demo.IMediator_Generated>();
                        return services;
                    }
                }
            }
            """;

    var test = new TerminusSourceGeneratorTest<EntryPointDiscoveryGenerator>
        {
            TestState =
            {
                Sources = { source }
            }
        };

        test.TestState.GeneratedSources.Add((typeof(EntryPointDiscoveryGenerator), "IMediator_Generated.g.cs", SourceText.From(expected, Encoding.UTF8)));

        await test.RunAsync();
    }
    
    
     [Fact]
     public async Task Given_a_parameterless_method_Should_generate_entry_point_command()
     {
         const string source =
             """
             using Terminus.Attributes;
             using System;
             using System.Threading.Tasks;

             namespace Demo
             {
                 [EntryPointMediator]
                 public partial interface IMediator;
                 
                 public class TestEntryPoints
                 {
                     [EntryPoint]
                     public Task Hello() 
                     { 
                         return Task.CompletedTask;
                     }
                 }
             }
             """;

         const string expected =
             """
             // <auto-generated/> Generated by Terminus EntryPointDiscoveryGenerator
             #nullable enable
             using Microsoft.Extensions.DependencyInjection;
             using System;
             using System.Reflection;
             using Terminus;
             using Terminus.Attributes;
             using Terminus.Strategies;
             
             namespace Demo
             {
                 public partial interface IMediator
                 {
                     System.Threading.Tasks.Task Hello();
                 }
             
                 internal sealed class IMediator_Generated : Demo.IMediator
                 {
                     private readonly IServiceProvider _serviceProvider;
                     private readonly ParameterBindingStrategyResolver _resolver;
                     public IMediator_Generated(IServiceProvider serviceProvider, ParameterBindingStrategyResolver resolver)
                     {
                         _serviceProvider = serviceProvider;
                         _resolver = resolver;
                     }
             
                     public System.Threading.Tasks.Task Hello()
                     {
                         using (var scope = _serviceProvider.CreateScope())
                         {
                             return scope.ServiceProvider.GetRequiredService<Demo.TestEntryPoints>().Hello();
                         }
                     }
                 }
             }
             
             namespace Terminus.Generated
             {
                 public static partial class ServiceCollectionExtensions
                 {
                     public static IServiceCollection AddEntryPointsForIMediator(this IServiceCollection services, Action<ParameterBindingStrategyResolver>? configure = null)
                     {
                         var resolver = new ParameterBindingStrategyResolver();
                         configure?.Invoke(resolver);
                         services.AddSingleton(resolver);
                         services.AddSingleton<EntryPointDescriptor<Terminus.Attributes.EntryPointAttribute>>(new EntryPointDescriptor<Terminus.Attributes.EntryPointAttribute>(typeof(Demo.TestEntryPoints).GetMethod("Hello", new System.Type[] { })!, context => context.ServiceProvider.GetRequiredService<Demo.TestEntryPoints>().Hello()));
                         services.AddSingleton<Demo.IMediator, Demo.IMediator_Generated>();
                         return services;
                     }
                 }
             }
             """;

     var test = new TerminusSourceGeneratorTest<EntryPointDiscoveryGenerator>
         {
             TestState =
             {
                 Sources = { source }
             }
         };

         test.TestState.GeneratedSources.Add((typeof(EntryPointDiscoveryGenerator), "IMediator_Generated.g.cs", SourceText.From(expected, Encoding.UTF8)));

         await test.RunAsync();
     }
}
