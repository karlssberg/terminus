using Microsoft.CodeAnalysis.Testing;

namespace Terminus.Generator.Tests.Unit.Generator;

public class PropertyGeneratorTests : SourceGeneratorTestBase<FacadeGenerator>
{
    private const string SourceFilename = "Source.cs";

    [Fact]
    public async Task Given_a_read_only_property_Should_generate_getter_only()
    {
        const string source =
            """
            using System;
            using Terminus;

            namespace Demo
            {
                [FacadeOf(typeof(FacadeMethodAttribute))]
                public partial interface IFacade;

                public class FacadeMethodAttribute : Attribute;

                public class ConfigService
                {
                    [FacadeMethod]
                    public int Timeout { get; }
                }
            }
            """;

        const string expected =
            """
            // <auto-generated/> Generated by Terminus FacadeGenerator
            #nullable enable
            namespace Demo
            {
                /// <summary>
                /// Facade interface delegating to: <see cref="Demo.ConfigService"/>
                /// </summary>
                [global::System.CodeDom.Compiler.GeneratedCode("Terminus.Generator", "1.0.0")]
                public partial interface IFacade
                {
                    /// <summary>
                    /// Delegates to:<br/>
                    /// <see cref="Demo.ConfigService.Timeout"/>
                    /// </summary>
                    int Timeout { get; }
                }

                [global::System.CodeDom.Compiler.GeneratedCode("Terminus.Generator", "1.0.0")]
                [global::Terminus.FacadeImplementation(typeof(global::Demo.IFacade))]
                /// <summary>
                /// Facade implementation class delegating to: <see cref="Demo.ConfigService"/>
                /// </summary>
                public sealed class IFacade_Generated : global::Demo.IFacade
                {
                    private readonly global::System.IServiceProvider _serviceProvider;
                    /// <summary>
                    /// Initializes a new instance of the IFacade_Generated class.
                    /// </summary>
                    /// <param name = "serviceProvider">The service provider used for resolving dependencies.</param>
                    public IFacade_Generated(global::System.IServiceProvider serviceProvider)
                    {
                        _serviceProvider = serviceProvider;
                    }

                    int global::Demo.IFacade.Timeout { get => global::Microsoft.Extensions.DependencyInjection.ServiceProviderServiceExtensions.GetRequiredService<global::Demo.ConfigService>(_serviceProvider).Timeout; }
                }
            }
            """;

        await VerifyAsync(source, ("Demo_IFacade_Generated.g.cs", expected));
    }

    [Fact]
    public async Task Given_a_read_write_property_Should_generate_getter_and_setter()
    {
        const string source =
            """
            using System;
            using Terminus;

            namespace Demo
            {
                [FacadeOf(typeof(FacadeMethodAttribute))]
                public partial interface IFacade;

                public class FacadeMethodAttribute : Attribute;

                public class ConfigService
                {
                    [FacadeMethod]
                    public string ConnectionString { get; set; }
                }
            }
            """;

        const string expected =
            """
            // <auto-generated/> Generated by Terminus FacadeGenerator
            #nullable enable
            namespace Demo
            {
                /// <summary>
                /// Facade interface delegating to: <see cref="Demo.ConfigService"/>
                /// </summary>
                [global::System.CodeDom.Compiler.GeneratedCode("Terminus.Generator", "1.0.0")]
                public partial interface IFacade
                {
                    /// <summary>
                    /// Delegates to:<br/>
                    /// <see cref="Demo.ConfigService.ConnectionString"/>
                    /// </summary>
                    string ConnectionString { get; set; }
                }

                [global::System.CodeDom.Compiler.GeneratedCode("Terminus.Generator", "1.0.0")]
                [global::Terminus.FacadeImplementation(typeof(global::Demo.IFacade))]
                /// <summary>
                /// Facade implementation class delegating to: <see cref="Demo.ConfigService"/>
                /// </summary>
                public sealed class IFacade_Generated : global::Demo.IFacade
                {
                    private readonly global::System.IServiceProvider _serviceProvider;
                    /// <summary>
                    /// Initializes a new instance of the IFacade_Generated class.
                    /// </summary>
                    /// <param name = "serviceProvider">The service provider used for resolving dependencies.</param>
                    public IFacade_Generated(global::System.IServiceProvider serviceProvider)
                    {
                        _serviceProvider = serviceProvider;
                    }

                    string global::Demo.IFacade.ConnectionString { get => global::Microsoft.Extensions.DependencyInjection.ServiceProviderServiceExtensions.GetRequiredService<global::Demo.ConfigService>(_serviceProvider).ConnectionString; set => global::Microsoft.Extensions.DependencyInjection.ServiceProviderServiceExtensions.GetRequiredService<global::Demo.ConfigService>(_serviceProvider).ConnectionString = value; }
                }
            }
            """;

        await VerifyAsync(source, ("Demo_IFacade_Generated.g.cs", expected));
    }

    [Fact]
    public async Task Given_a_static_property_Should_generate_static_access()
    {
        const string source =
            """
            using System;
            using Terminus;

            namespace Demo
            {
                [FacadeOf(typeof(FacadeMethodAttribute))]
                public partial interface IFacade;

                public class FacadeMethodAttribute : Attribute;

                public static class GlobalConfig
                {
                    [FacadeMethod]
                    public static string AppName { get; set; }
                }
            }
            """;

        const string expected =
            """
            // <auto-generated/> Generated by Terminus FacadeGenerator
            #nullable enable
            namespace Demo
            {
                /// <summary>
                /// Facade interface delegating to: <see cref="Demo.GlobalConfig"/>
                /// </summary>
                [global::System.CodeDom.Compiler.GeneratedCode("Terminus.Generator", "1.0.0")]
                public partial interface IFacade
                {
                    /// <summary>
                    /// Delegates to:<br/>
                    /// <see cref="Demo.GlobalConfig.AppName"/>
                    /// </summary>
                    string AppName { get; set; }
                }

                [global::System.CodeDom.Compiler.GeneratedCode("Terminus.Generator", "1.0.0")]
                [global::Terminus.FacadeImplementation(typeof(global::Demo.IFacade))]
                /// <summary>
                /// Facade implementation class delegating to: <see cref="Demo.GlobalConfig"/>
                /// </summary>
                public sealed class IFacade_Generated : global::Demo.IFacade
                {
                    private readonly global::System.IServiceProvider _serviceProvider;
                    /// <summary>
                    /// Initializes a new instance of the IFacade_Generated class.
                    /// </summary>
                    /// <param name = "serviceProvider">The service provider used for resolving dependencies.</param>
                    public IFacade_Generated(global::System.IServiceProvider serviceProvider)
                    {
                        _serviceProvider = serviceProvider;
                    }

                    string global::Demo.IFacade.AppName { get => global::Demo.GlobalConfig.AppName; set => global::Demo.GlobalConfig.AppName = value; }
                }
            }
            """;

        await VerifyAsync(source, ("Demo_IFacade_Generated.g.cs", expected));
    }

    [Fact]
    public async Task Given_a_scoped_instance_property_Should_generate_scoped_resolution()
    {
        const string source =
            """
            using System;
            using Terminus;

            namespace Demo
            {
                [FacadeOf(typeof(FacadeMethodAttribute), Scoped = true)]
                public partial interface IFacade;

                public class FacadeMethodAttribute : Attribute;

                public class ConfigService
                {
                    [FacadeMethod]
                    public string Value { get; set; }
                }
            }
            """;

        const string expected =
            """
            // <auto-generated/> Generated by Terminus FacadeGenerator
            #nullable enable
            namespace Demo
            {
                /// <summary>
                /// Facade interface delegating to: <see cref="Demo.ConfigService"/>
                /// </summary>
                [global::System.CodeDom.Compiler.GeneratedCode("Terminus.Generator", "1.0.0")]
                public partial interface IFacade
                {
                    /// <summary>
                    /// Delegates to:<br/>
                    /// <see cref="Demo.ConfigService.Value"/>
                    /// </summary>
                    string Value { get; set; }
                }

                [global::System.CodeDom.Compiler.GeneratedCode("Terminus.Generator", "1.0.0")]
                [global::Terminus.FacadeImplementation(typeof(global::Demo.IFacade))]
                /// <summary>
                /// Facade implementation class delegating to: <see cref="Demo.ConfigService"/>
                /// </summary>
                public sealed class IFacade_Generated : global::Demo.IFacade, global::System.IDisposable, global::System.IAsyncDisposable
                {
                    private bool _syncDisposed;
                    private bool _asyncDisposed;
                    private readonly global::System.Lazy<global::Microsoft.Extensions.DependencyInjection.IServiceScope> _syncScope;
                    private readonly global::System.Lazy<global::Microsoft.Extensions.DependencyInjection.AsyncServiceScope> _asyncScope;
                    /// <summary>
                    /// Initializes a new instance of the IFacade_Generated class.
                    /// </summary>
                    /// <param name = "serviceProvider">The service provider used for resolving dependencies.</param>
                    public IFacade_Generated(global::System.IServiceProvider serviceProvider)
                    {
                        _syncScope = new global::System.Lazy<global::Microsoft.Extensions.DependencyInjection.IServiceScope>(() => global::Microsoft.Extensions.DependencyInjection.ServiceProviderServiceExtensions.GetRequiredService<global::Microsoft.Extensions.DependencyInjection.IServiceScopeFactory>(serviceProvider).CreateScope());
                        _asyncScope = new global::System.Lazy<global::Microsoft.Extensions.DependencyInjection.AsyncServiceScope>(() => global::Microsoft.Extensions.DependencyInjection.ServiceProviderServiceExtensions.CreateAsyncScope(serviceProvider));
                    }

                    string global::Demo.IFacade.Value { get => global::Microsoft.Extensions.DependencyInjection.ServiceProviderServiceExtensions.GetRequiredService<global::Demo.ConfigService>(_syncScope.Value.ServiceProvider).Value; set => global::Microsoft.Extensions.DependencyInjection.ServiceProviderServiceExtensions.GetRequiredService<global::Demo.ConfigService>(_syncScope.Value.ServiceProvider).Value = value; }

                    /// <summary>
                    /// Disposes the synchronous service scope.
                    /// </summary>
                    public void Dispose()
                    {
                        if (_syncDisposed || !_syncScope.IsValueCreated)
                            return;
                        _syncScope.Value.Dispose();
                        _syncDisposed = true;
                        global::System.GC.SuppressFinalize(this);
                    }

                    /// <summary>
                    /// Disposes the asynchronous service scope.
                    /// </summary>
                    /// <returns>A <see cref = "global::System.Threading.Tasks.ValueTask"/> representing the asynchronous operation.</returns>
                    public async global::System.Threading.Tasks.ValueTask DisposeAsync()
                    {
                        if (_asyncDisposed || !_asyncScope.IsValueCreated)
                            return;
                        await _asyncScope.Value.DisposeAsync().ConfigureAwait(false);
                        _asyncDisposed = true;
                        global::System.GC.SuppressFinalize(this);
                    }
                }
            }
            """;

        await VerifyAsync(source, ("Demo_IFacade_Generated.g.cs", expected));
    }

    [Fact]
    public async Task Given_a_class_level_attribute_Should_include_public_properties()
    {
        const string source =
            """
            using System;
            using Terminus;

            namespace Demo
            {
                [FacadeOf(typeof(FacadeMethodAttribute))]
                public partial interface IFacade;

                public class FacadeMethodAttribute : Attribute;

                [FacadeMethod]
                public class ConfigService
                {
                    public string Name { get; set; }
                    public int Count { get; }
                }
            }
            """;

        const string expected =
            """
            // <auto-generated/> Generated by Terminus FacadeGenerator
            #nullable enable
            namespace Demo
            {
                /// <summary>
                /// Facade interface delegating to: <see cref="Demo.ConfigService"/>
                /// </summary>
                [global::System.CodeDom.Compiler.GeneratedCode("Terminus.Generator", "1.0.0")]
                public partial interface IFacade
                {
                    /// <summary>
                    /// Delegates to:<br/>
                    /// <see cref="Demo.ConfigService.Count"/>
                    /// </summary>
                    int Count { get; }

                    /// <summary>
                    /// Delegates to:<br/>
                    /// <see cref="Demo.ConfigService.Name"/>
                    /// </summary>
                    string Name { get; set; }
                }

                [global::System.CodeDom.Compiler.GeneratedCode("Terminus.Generator", "1.0.0")]
                [global::Terminus.FacadeImplementation(typeof(global::Demo.IFacade))]
                /// <summary>
                /// Facade implementation class delegating to: <see cref="Demo.ConfigService"/>
                /// </summary>
                public sealed class IFacade_Generated : global::Demo.IFacade
                {
                    private readonly global::System.IServiceProvider _serviceProvider;
                    /// <summary>
                    /// Initializes a new instance of the IFacade_Generated class.
                    /// </summary>
                    /// <param name = "serviceProvider">The service provider used for resolving dependencies.</param>
                    public IFacade_Generated(global::System.IServiceProvider serviceProvider)
                    {
                        _serviceProvider = serviceProvider;
                    }

                    int global::Demo.IFacade.Count { get => global::Microsoft.Extensions.DependencyInjection.ServiceProviderServiceExtensions.GetRequiredService<global::Demo.ConfigService>(_serviceProvider).Count; }

                    string global::Demo.IFacade.Name { get => global::Microsoft.Extensions.DependencyInjection.ServiceProviderServiceExtensions.GetRequiredService<global::Demo.ConfigService>(_serviceProvider).Name; set => global::Microsoft.Extensions.DependencyInjection.ServiceProviderServiceExtensions.GetRequiredService<global::Demo.ConfigService>(_serviceProvider).Name = value; }
                }
            }
            """;

        await VerifyAsync(source, ("Demo_IFacade_Generated.g.cs", expected));
    }

    [Fact]
    public async Task Given_duplicate_property_names_Should_report_TM0005_error()
    {
        const string source =
            """
            using System;
            using Terminus;

            namespace Demo
            {
                [FacadeOf(typeof(FacadeMethodAttribute))]
                public partial interface IFacade;

                public class FacadeMethodAttribute : Attribute;

                public class ServiceA
                {
                    [FacadeMethod]
                    public string Config { get; set; }
                }

                public class ServiceB
                {
                    [FacadeMethod]
                    public string Config { get; set; }
                }
            }
            """;

        await VerifyAsync(
            source,
            expectedDiagnostics:
            [
                DiagnosticResult.CompilerError("TM0005")
                    .WithSpan(SourceFilename, 14, 23, 14, 29)
                    .WithArguments("Config"),
                DiagnosticResult.CompilerError("TM0005")
                    .WithSpan(SourceFilename, 20, 23, 20, 29)
                    .WithArguments("Config"),
            ],
            sourceFilename: SourceFilename);
    }

    [Fact]
    public async Task Given_mixed_methods_and_properties_Should_generate_both()
    {
        const string source =
            """
            using System;
            using Terminus;

            namespace Demo
            {
                [FacadeOf(typeof(FacadeMethodAttribute))]
                public partial interface IFacade;

                public class FacadeMethodAttribute : Attribute;

                public class ConfigService
                {
                    [FacadeMethod]
                    public string Name { get; set; }

                    [FacadeMethod]
                    public void Initialize(string value) { }
                }
            }
            """;

        const string expected =
            """
            // <auto-generated/> Generated by Terminus FacadeGenerator
            #nullable enable
            namespace Demo
            {
                /// <summary>
                /// Facade interface delegating to: <see cref="Demo.ConfigService"/>
                /// </summary>
                [global::System.CodeDom.Compiler.GeneratedCode("Terminus.Generator", "1.0.0")]
                public partial interface IFacade
                {
                    /// <summary>
                    /// Delegates to:<br/>
                    /// <see cref="Demo.ConfigService.Initialize(string)"/>
                    /// </summary>
                    void Initialize(string value);
                    /// <summary>
                    /// Delegates to:<br/>
                    /// <see cref="Demo.ConfigService.Name"/>
                    /// </summary>
                    string Name { get; set; }
                }

                [global::System.CodeDom.Compiler.GeneratedCode("Terminus.Generator", "1.0.0")]
                [global::Terminus.FacadeImplementation(typeof(global::Demo.IFacade))]
                /// <summary>
                /// Facade implementation class delegating to: <see cref="Demo.ConfigService"/>
                /// </summary>
                public sealed class IFacade_Generated : global::Demo.IFacade
                {
                    private readonly global::System.IServiceProvider _serviceProvider;
                    /// <summary>
                    /// Initializes a new instance of the IFacade_Generated class.
                    /// </summary>
                    /// <param name = "serviceProvider">The service provider used for resolving dependencies.</param>
                    public IFacade_Generated(global::System.IServiceProvider serviceProvider)
                    {
                        _serviceProvider = serviceProvider;
                    }

                    void global::Demo.IFacade.Initialize(string value)
                    {
                        global::Microsoft.Extensions.DependencyInjection.ServiceProviderServiceExtensions.GetRequiredService<global::Demo.ConfigService>(_serviceProvider).Initialize(value);
                    }

                    string global::Demo.IFacade.Name { get => global::Microsoft.Extensions.DependencyInjection.ServiceProviderServiceExtensions.GetRequiredService<global::Demo.ConfigService>(_serviceProvider).Name; set => global::Microsoft.Extensions.DependencyInjection.ServiceProviderServiceExtensions.GetRequiredService<global::Demo.ConfigService>(_serviceProvider).Name = value; }
                }
            }
            """;

        await VerifyAsync(source, ("Demo_IFacade_Generated.g.cs", expected));
    }

    [Fact]
    public async Task Given_init_only_setter_Should_generate_getter_only()
    {
        // Init-only setters cannot be assigned outside of object initializers,
        // so they are treated as read-only from the facade's perspective.
        const string source =
            """
            using System;
            using Terminus;

            namespace Demo
            {
                [FacadeOf(typeof(FacadeMethodAttribute))]
                public partial interface IFacade;

                public class FacadeMethodAttribute : Attribute;

                public class ConfigService
                {
                    [FacadeMethod]
                    public string Name { get; init; }
                }
            }
            """;

        const string expected =
            """
            // <auto-generated/> Generated by Terminus FacadeGenerator
            #nullable enable
            namespace Demo
            {
                /// <summary>
                /// Facade interface delegating to: <see cref="Demo.ConfigService"/>
                /// </summary>
                [global::System.CodeDom.Compiler.GeneratedCode("Terminus.Generator", "1.0.0")]
                public partial interface IFacade
                {
                    /// <summary>
                    /// Delegates to:<br/>
                    /// <see cref="Demo.ConfigService.Name"/>
                    /// </summary>
                    string Name { get; }
                }

                [global::System.CodeDom.Compiler.GeneratedCode("Terminus.Generator", "1.0.0")]
                [global::Terminus.FacadeImplementation(typeof(global::Demo.IFacade))]
                /// <summary>
                /// Facade implementation class delegating to: <see cref="Demo.ConfigService"/>
                /// </summary>
                public sealed class IFacade_Generated : global::Demo.IFacade
                {
                    private readonly global::System.IServiceProvider _serviceProvider;
                    /// <summary>
                    /// Initializes a new instance of the IFacade_Generated class.
                    /// </summary>
                    /// <param name = "serviceProvider">The service provider used for resolving dependencies.</param>
                    public IFacade_Generated(global::System.IServiceProvider serviceProvider)
                    {
                        _serviceProvider = serviceProvider;
                    }

                    string global::Demo.IFacade.Name { get => global::Microsoft.Extensions.DependencyInjection.ServiceProviderServiceExtensions.GetRequiredService<global::Demo.ConfigService>(_serviceProvider).Name; }
                }
            }
            """;

        await VerifyAsync(source, ("Demo_IFacade_Generated.g.cs", expected));
    }
}
