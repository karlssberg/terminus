namespace Terminus.Generator.Tests.Unit.Generator;

public class FacadeGeneratorTests : SourceGeneratorTestBase<FacadeGenerator>
{
    [Fact]
    public async Task Given_a_single_parameter_method_Should_generate_entry_point_command()
    {
        const string source =
            """
            using System;
            using Terminus;
            using System.Threading;

            namespace Demo
            {
                [FacadeOf(typeof(FacadeMethodAttribute), CreateScope=true)]
                public partial interface IFacade;

                public class FacadeMethodAttribute : Attribute;

                public static class TestFacadeMethods
                {
                    [FacadeMethod]
                    public static void Hello(string world, CancellationToken cancellationToken)
                    {
                        Console.WriteLine($"hello {world}");
                    }
                }
            }
            """;

        const string expectedMainSource =
            """
            // <auto-generated/> Generated by Terminus FacadeGenerator
            #nullable enable
            namespace Demo
            {
                /// <summary>
                /// Facade interface delegating to: <see cref="Demo.TestFacadeMethods"/>
                /// </summary>
                [global::System.CodeDom.Compiler.GeneratedCode("Terminus.Generator", "1.0.0")]
                public partial interface IFacade
                {
                    /// <summary>
                    /// Delegates to:<br/>
                    /// <see cref="Demo.TestFacadeMethods.Hello(string, System.Threading.CancellationToken)"/>
                    /// </summary>
                    void Hello(string world, global::System.Threading.CancellationToken cancellationToken);
                }

                [global::System.CodeDom.Compiler.GeneratedCode("Terminus.Generator", "1.0.0")]
                /// <summary>
                /// Facade implementation class delegating to: <see cref="Demo.TestFacadeMethods"/>
                /// </summary>
                public sealed class IFacade_Generated : global::Demo.IFacade
                {
                    void global::Demo.IFacade.Hello(string world, global::System.Threading.CancellationToken cancellationToken)
                    {
                        cancellationToken.ThrowIfCancellationRequested();
                        global::Demo.TestFacadeMethods.Hello(world, cancellationToken);
                    }
                }
            }
            """;

        await VerifyAsync(
            source,
            ("Demo_IFacade_Generated.g.cs", expectedMainSource));
    }

    [Fact]
    public async Task Given_a_static_target_containing_type_Should_not_generate_service_registration()
    {
        const string source =
            """
            using System;
            using Terminus;

            namespace Demo
            {
                [FacadeOf(typeof(FacadeMethodAttribute))]
                public partial interface IFacade;

                public class FacadeMethodAttribute : Attribute;

                public static class TestFacadeMethods
                {
                    [FacadeMethod]
                    public static void Hello(string world)
                    {
                        Console.WriteLine($"hello {world}");
                    }
                }
            }
            """;

        const string expectedMainSource =
            """
            // <auto-generated/> Generated by Terminus FacadeGenerator
            #nullable enable
            namespace Demo
            {
                /// <summary>
                /// Facade interface delegating to: <see cref="Demo.TestFacadeMethods"/>
                /// </summary>
                [global::System.CodeDom.Compiler.GeneratedCode("Terminus.Generator", "1.0.0")]
                public partial interface IFacade
                {
                    /// <summary>
                    /// Delegates to:<br/>
                    /// <see cref="Demo.TestFacadeMethods.Hello(string)"/>
                    /// </summary>
                    void Hello(string world);
                }

                [global::System.CodeDom.Compiler.GeneratedCode("Terminus.Generator", "1.0.0")]
                [global::Terminus.FacadeImplementation(typeof(global::Demo.IFacade))]
                /// <summary>
                /// Facade implementation class delegating to: <see cref="Demo.TestFacadeMethods"/>
                /// </summary>
                public sealed class IFacade_Generated : global::Demo.IFacade
                {
                    private readonly global::System.IServiceProvider _serviceProvider;
                    /// <summary>
                    /// Initializes a new instance of the IFacade_Generated class.
                    /// </summary>
                    /// <param name = "serviceProvider">The service provider used for resolving dependencies.</param>
                    public IFacade_Generated(global::System.IServiceProvider serviceProvider)
                    {
                        _serviceProvider = serviceProvider;
                    }

                    void global::Demo.IFacade.Hello(string world)
                    {
                        global::Demo.TestFacadeMethods.Hello(world);
                    }
                }
            }
            """;

        await VerifyAsync(
            source,
            ("Demo_IFacade_Generated.g.cs", expectedMainSource));
    }

    [Fact]
    public async Task Given_a_async_methods_Should_generate_async_entry_points_facade_methods()
    {
        const string source =
            """
            using System;
            using System.Threading.Tasks;
            using Terminus;

            namespace Demo
            {
                [FacadeOf(typeof(FacadeMethodAttribute), CreateScope=true)]
                public partial interface IFacade;

                public class FacadeMethodAttribute : Attribute;

                public class TestFacadeMethods
                {
                    [FacadeMethod]
                    public Task HelloAsync()
                    {
                        return Task.CompletedTask;
                    }

                    [FacadeMethod]
                    public async Task<string> HelloAsync(string world)
                    {
                        return await Task.FromResult(world);
                    }

                    [FacadeMethod]
                    public void Hello()
                    {
                    }

                    [FacadeMethod]
                    public string Hello(string world)
                    {
                         return world;
                    }
                }
            }
            """;

        const string expectedMainSource =
            $$"""
              // <auto-generated/> Generated by Terminus FacadeGenerator
              #nullable enable
              namespace Demo
              {
                  /// <summary>
                  /// Facade interface delegating to: <see cref="Demo.TestFacadeMethods"/>
                  /// </summary>
                  [global::System.CodeDom.Compiler.GeneratedCode("Terminus.Generator", "1.0.0")]
                  public partial interface IFacade
                  {
                      /// <summary>
                      /// Delegates to:<br/>
                      /// <see cref="Demo.TestFacadeMethods.HelloAsync"/>
                      /// </summary>
                      global::System.Threading.Tasks.Task HelloAsync();
                      /// <summary>
                      /// Delegates to:<br/>
                      /// <see cref="Demo.TestFacadeMethods.HelloAsync(string)"/>
                      /// </summary>
                      global::System.Threading.Tasks.Task<string> HelloAsync(string world);
                      /// <summary>
                      /// Delegates to:<br/>
                      /// <see cref="Demo.TestFacadeMethods.Hello"/>
                      /// </summary>
                      void Hello();
                      /// <summary>
                      /// Delegates to:<br/>
                      /// <see cref="Demo.TestFacadeMethods.Hello(string)"/>
                      /// </summary>
                      string Hello(string world);
                  }

                  [global::System.CodeDom.Compiler.GeneratedCode("Terminus.Generator", "1.0.0")]
                  [global::Terminus.FacadeImplementation(typeof(global::Demo.IFacade))]
                  /// <summary>
                  /// Facade implementation class delegating to: <see cref="Demo.TestFacadeMethods"/>
                  /// </summary>
                  public sealed class IFacade_Generated : global::Demo.IFacade, global::System.IDisposable, global::System.IAsyncDisposable
                  {
                      private bool _syncDisposed;
                      private bool _asyncDisposed;
                      private readonly global::System.Lazy<global::Microsoft.Extensions.DependencyInjection.IServiceScope> _syncScope;
                      private readonly global::System.Lazy<global::Microsoft.Extensions.DependencyInjection.AsyncServiceScope> _asyncScope;
                      /// <summary>
                      /// Initializes a new instance of the IFacade_Generated class.
                      /// </summary>
                      /// <param name = "serviceProvider">The service provider used for resolving dependencies.</param>
                      public IFacade_Generated(global::System.IServiceProvider serviceProvider)
                      {
                          _syncScope = new global::System.Lazy<global::Microsoft.Extensions.DependencyInjection.IServiceScope>(() => global::Microsoft.Extensions.DependencyInjection.ServiceProviderServiceExtensions.GetRequiredService<global::Microsoft.Extensions.DependencyInjection.IServiceScopeFactory>(serviceProvider).CreateScope());
                          _asyncScope = new global::System.Lazy<global::Microsoft.Extensions.DependencyInjection.AsyncServiceScope>(() => global::Microsoft.Extensions.DependencyInjection.ServiceProviderServiceExtensions.CreateAsyncScope(serviceProvider));
                      }

                      async global::System.Threading.Tasks.Task global::Demo.IFacade.HelloAsync()
                      {
                          await global::Microsoft.Extensions.DependencyInjection.ServiceProviderServiceExtensions.GetRequiredService<global::Demo.TestFacadeMethods>(_asyncScope.Value.ServiceProvider).HelloAsync().ConfigureAwait(false);
                      }

                      async global::System.Threading.Tasks.Task<string> global::Demo.IFacade.HelloAsync(string world)
                      {
                          return await global::Microsoft.Extensions.DependencyInjection.ServiceProviderServiceExtensions.GetRequiredService<global::Demo.TestFacadeMethods>(_asyncScope.Value.ServiceProvider).HelloAsync(world).ConfigureAwait(false);
                      }

                      void global::Demo.IFacade.Hello()
                      {
                          global::Microsoft.Extensions.DependencyInjection.ServiceProviderServiceExtensions.GetRequiredService<global::Demo.TestFacadeMethods>(_syncScope.Value.ServiceProvider).Hello();
                      }

                      string global::Demo.IFacade.Hello(string world)
                      {
                          return global::Microsoft.Extensions.DependencyInjection.ServiceProviderServiceExtensions.GetRequiredService<global::Demo.TestFacadeMethods>(_syncScope.Value.ServiceProvider).Hello(world);
                      }

                      /// <summary>
                      /// Disposes the synchronous service scope.
                      /// </summary>
                      public void Dispose()
                      {
                          if (_syncDisposed || !_syncScope.IsValueCreated)
                              return;
                          _syncScope.Value.Dispose();
                          _syncDisposed = true;
                          global::System.GC.SuppressFinalize(this);
                      }

                      /// <summary>
                      /// Disposes the asynchronous service scope.
                      /// </summary>
                      /// <returns>A <see cref = "global::System.Threading.Tasks.ValueTask"/> representing the asynchronous operation.</returns>
                      public async global::System.Threading.Tasks.ValueTask DisposeAsync()
                      {
                          if (_asyncDisposed || !_asyncScope.IsValueCreated)
                              return;
                          await _asyncScope.Value.DisposeAsync().ConfigureAwait(false);
                          _asyncDisposed = true;
                          global::System.GC.SuppressFinalize(this);
                      }
                  }
              }
              """;

        await VerifyAsync(
            source,
            ("Demo_IFacade_Generated.g.cs", expectedMainSource));
    }

    [Fact]
    public async Task Given_an_opt_out_from_generating_scopes_Should_not_generate_scopes()
    {
        const string source =
            """
            using System;
            using System.Threading.Tasks;
            using Terminus;

            namespace Demo
            {
                [FacadeOf(typeof(FacadeMethodAttribute), CreateScope=false)]
                public partial interface IFacade;

                public class FacadeMethodAttribute : Attribute;

                public class TestFacadeMethods
                {
                    [FacadeMethod]
                    public void Hello()
                    {
                    }

                    [FacadeMethod]
                    public string Hello(string world)
                    {
                       return world;
                    }

                    [FacadeMethod]
                    public Task HelloAsync()
                    {
                       return Task.CompletedTask;
                    }

                    [FacadeMethod]
                    public async Task<string> HelloAsync(string world)
                    {
                         return await Task.FromResult(world);
                    }
                }
            }
            """;

        const string expectedMainSource =
            $$"""
              // <auto-generated/> Generated by Terminus FacadeGenerator
              #nullable enable
              namespace Demo
              {
                  /// <summary>
                  /// Facade interface delegating to: <see cref="Demo.TestFacadeMethods"/>
                  /// </summary>
                  [global::System.CodeDom.Compiler.GeneratedCode("Terminus.Generator", "1.0.0")]
                  public partial interface IFacade
                  {
                      /// <summary>
                      /// Delegates to:<br/>
                      /// <see cref="Demo.TestFacadeMethods.Hello"/>
                      /// </summary>
                      void Hello();
                      /// <summary>
                      /// Delegates to:<br/>
                      /// <see cref="Demo.TestFacadeMethods.Hello(string)"/>
                      /// </summary>
                      string Hello(string world);
                      /// <summary>
                      /// Delegates to:<br/>
                      /// <see cref="Demo.TestFacadeMethods.HelloAsync"/>
                      /// </summary>
                      global::System.Threading.Tasks.Task HelloAsync();
                      /// <summary>
                      /// Delegates to:<br/>
                      /// <see cref="Demo.TestFacadeMethods.HelloAsync(string)"/>
                      /// </summary>
                      global::System.Threading.Tasks.Task<string> HelloAsync(string world);
                  }

                  [global::System.CodeDom.Compiler.GeneratedCode("Terminus.Generator", "1.0.0")]
                  [global::Terminus.FacadeImplementation(typeof(global::Demo.IFacade))]
                  /// <summary>
                  /// Facade implementation class delegating to: <see cref="Demo.TestFacadeMethods"/>
                  /// </summary>
                  public sealed class IFacade_Generated : global::Demo.IFacade
                  {
                      private readonly global::System.IServiceProvider _serviceProvider;
                      /// <summary>
                      /// Initializes a new instance of the IFacade_Generated class.
                      /// </summary>
                      /// <param name = "serviceProvider">The service provider used for resolving dependencies.</param>
                      public IFacade_Generated(global::System.IServiceProvider serviceProvider)
                      {
                          _serviceProvider = serviceProvider;
                      }

                      void global::Demo.IFacade.Hello()
                      {
                          global::Microsoft.Extensions.DependencyInjection.ServiceProviderServiceExtensions.GetRequiredService<global::Demo.TestFacadeMethods>(_serviceProvider).Hello();
                      }

                      string global::Demo.IFacade.Hello(string world)
                      {
                          return global::Microsoft.Extensions.DependencyInjection.ServiceProviderServiceExtensions.GetRequiredService<global::Demo.TestFacadeMethods>(_serviceProvider).Hello(world);
                      }

                      async global::System.Threading.Tasks.Task global::Demo.IFacade.HelloAsync()
                      {
                          await global::Microsoft.Extensions.DependencyInjection.ServiceProviderServiceExtensions.GetRequiredService<global::Demo.TestFacadeMethods>(_serviceProvider).HelloAsync().ConfigureAwait(false);
                      }

                      async global::System.Threading.Tasks.Task<string> global::Demo.IFacade.HelloAsync(string world)
                      {
                          return await global::Microsoft.Extensions.DependencyInjection.ServiceProviderServiceExtensions.GetRequiredService<global::Demo.TestFacadeMethods>(_serviceProvider).HelloAsync(world).ConfigureAwait(false);
                      }
                  }
              }
              """;

        await VerifyAsync(
            source,
            ("Demo_IFacade_Generated.g.cs", expectedMainSource));
    }

    [Fact]
    public async Task Given_the_entry_point_attribute_is_derived_Should_generate_facade_methods()
    {
        const string source =
            """
            using System;
            using System.Threading.Tasks;
            using Terminus;

            namespace Demo
            {
                [FacadeOf(typeof(MyFacadeMethodAttribute), CreateScope=true)]
                public partial interface IFacade;
                
                public class MyFacadeMethodAttribute : Attribute;
                
                public class TestFacadeMethods
                {
                    [MyFacadeMethod]
                    public void Hello() 
                    {
                    }
                    
                    [MyFacadeMethod]
                    public  string Hello(string world) 
                    { 
                        return world;
                    }

                    [MyFacadeMethod]
                    public Task HelloAsync() 
                    { 
                        return Task.CompletedTask;
                    }
                    
                    [MyFacadeMethod]
                    public async Task<string> HelloAsync(string world) 
                    { 
                         return await Task.FromResult(world);
                    }
                }
            }
            """;

        const string expectedMainSource =
            """
            // <auto-generated/> Generated by Terminus FacadeGenerator
            #nullable enable
            namespace Demo
            {
                /// <summary>
                /// Facade interface delegating to: <see cref="Demo.TestFacadeMethods"/>
                /// </summary>
                [global::System.CodeDom.Compiler.GeneratedCode("Terminus.Generator", "1.0.0")]
                public partial interface IFacade
                {
                    /// <summary>
                    /// Delegates to:<br/>
                    /// <see cref="Demo.TestFacadeMethods.Hello"/>
                    /// </summary>
                    void Hello();
                    /// <summary>
                    /// Delegates to:<br/>
                    /// <see cref="Demo.TestFacadeMethods.Hello(string)"/>
                    /// </summary>
                    string Hello(string world);
                    /// <summary>
                    /// Delegates to:<br/>
                    /// <see cref="Demo.TestFacadeMethods.HelloAsync"/>
                    /// </summary>
                    global::System.Threading.Tasks.Task HelloAsync();
                    /// <summary>
                    /// Delegates to:<br/>
                    /// <see cref="Demo.TestFacadeMethods.HelloAsync(string)"/>
                    /// </summary>
                    global::System.Threading.Tasks.Task<string> HelloAsync(string world);
                }

                [global::System.CodeDom.Compiler.GeneratedCode("Terminus.Generator", "1.0.0")]
                [global::Terminus.FacadeImplementation(typeof(global::Demo.IFacade))]
                /// <summary>
                /// Facade implementation class delegating to: <see cref="Demo.TestFacadeMethods"/>
                /// </summary>
                public sealed class IFacade_Generated : global::Demo.IFacade, global::System.IDisposable, global::System.IAsyncDisposable
                {
                    private bool _syncDisposed;
                    private bool _asyncDisposed;
                    private readonly global::System.Lazy<global::Microsoft.Extensions.DependencyInjection.IServiceScope> _syncScope;
                    private readonly global::System.Lazy<global::Microsoft.Extensions.DependencyInjection.AsyncServiceScope> _asyncScope;
                    /// <summary>
                    /// Initializes a new instance of the IFacade_Generated class.
                    /// </summary>
                    /// <param name = "serviceProvider">The service provider used for resolving dependencies.</param>
                    public IFacade_Generated(global::System.IServiceProvider serviceProvider)
                    {
                        _syncScope = new global::System.Lazy<global::Microsoft.Extensions.DependencyInjection.IServiceScope>(() => global::Microsoft.Extensions.DependencyInjection.ServiceProviderServiceExtensions.GetRequiredService<global::Microsoft.Extensions.DependencyInjection.IServiceScopeFactory>(serviceProvider).CreateScope());
                        _asyncScope = new global::System.Lazy<global::Microsoft.Extensions.DependencyInjection.AsyncServiceScope>(() => global::Microsoft.Extensions.DependencyInjection.ServiceProviderServiceExtensions.CreateAsyncScope(serviceProvider));
                    }

                    void global::Demo.IFacade.Hello()
                    {
                        global::Microsoft.Extensions.DependencyInjection.ServiceProviderServiceExtensions.GetRequiredService<global::Demo.TestFacadeMethods>(_syncScope.Value.ServiceProvider).Hello();
                    }

                    string global::Demo.IFacade.Hello(string world)
                    {
                        return global::Microsoft.Extensions.DependencyInjection.ServiceProviderServiceExtensions.GetRequiredService<global::Demo.TestFacadeMethods>(_syncScope.Value.ServiceProvider).Hello(world);
                    }

                    async global::System.Threading.Tasks.Task global::Demo.IFacade.HelloAsync()
                    {
                        await global::Microsoft.Extensions.DependencyInjection.ServiceProviderServiceExtensions.GetRequiredService<global::Demo.TestFacadeMethods>(_asyncScope.Value.ServiceProvider).HelloAsync().ConfigureAwait(false);
                    }

                    async global::System.Threading.Tasks.Task<string> global::Demo.IFacade.HelloAsync(string world)
                    {
                        return await global::Microsoft.Extensions.DependencyInjection.ServiceProviderServiceExtensions.GetRequiredService<global::Demo.TestFacadeMethods>(_asyncScope.Value.ServiceProvider).HelloAsync(world).ConfigureAwait(false);
                    }

                    /// <summary>
                    /// Disposes the synchronous service scope.
                    /// </summary>
                    public void Dispose()
                    {
                        if (_syncDisposed || !_syncScope.IsValueCreated)
                            return;
                        _syncScope.Value.Dispose();
                        _syncDisposed = true;
                        global::System.GC.SuppressFinalize(this);
                    }

                    /// <summary>
                    /// Disposes the asynchronous service scope.
                    /// </summary>
                    /// <returns>A <see cref = "global::System.Threading.Tasks.ValueTask"/> representing the asynchronous operation.</returns>
                    public async global::System.Threading.Tasks.ValueTask DisposeAsync()
                    {
                        if (_asyncDisposed || !_asyncScope.IsValueCreated)
                            return;
                        await _asyncScope.Value.DisposeAsync().ConfigureAwait(false);
                        _asyncDisposed = true;
                        global::System.GC.SuppressFinalize(this);
                    }
                }
            }
            """;

        await VerifyAsync(
            source,
            ("Demo_IFacade_Generated.g.cs", expectedMainSource));
    }

#if NETCOREAPP3_0_OR_GREATER || NETSTANDARD2_1_OR_GREATER
    [Fact]
    public async Task Given_IAsyncEnumerable_entry_point_in_scoped_facade_Should_create_async_method()
    {
        const string source =
            """
            using System.Collections.Generic;
            using Terminus;
            using System;

            namespace Demo
            {
                [FacadeOf(typeof(FacadeMethodAttribute), CreateScope=true)]
                public partial interface IFacade;

                public class FacadeMethodAttribute : Attribute;

                public class TestFacadeMethods
                {
                    [FacadeMethod]
                    public async IAsyncEnumerable<int> Stream()
                    {
                        yield return 1;
                    }
                }
            }
            """;

        string expectedMainSource =
            """
            // <auto-generated/> Generated by Terminus FacadeGenerator
            #nullable enable
            namespace Demo
            {
                /// <summary>
                /// Facade interface delegating to: <see cref="Demo.TestFacadeMethods"/>
                /// </summary>
                [global::System.CodeDom.Compiler.GeneratedCode("Terminus.Generator", "1.0.0")]
                public partial interface IFacade
                {
                    /// <summary>
                    /// Delegates to:<br/>
                    /// <see cref="Demo.TestFacadeMethods.Stream"/>
                    /// </summary>
                    global::System.Collections.Generic.IAsyncEnumerable<int> Stream();
                }

                [global::System.CodeDom.Compiler.GeneratedCode("Terminus.Generator", "1.0.0")]
                [global::Terminus.FacadeImplementation(typeof(global::Demo.IFacade))]
                /// <summary>
                /// Facade implementation class delegating to: <see cref="Demo.TestFacadeMethods"/>
                /// </summary>
                public sealed class IFacade_Generated : global::Demo.IFacade, global::System.IDisposable, global::System.IAsyncDisposable
                {
                    private bool _syncDisposed;
                    private bool _asyncDisposed;
                    private readonly global::System.Lazy<global::Microsoft.Extensions.DependencyInjection.IServiceScope> _syncScope;
                    private readonly global::System.Lazy<global::Microsoft.Extensions.DependencyInjection.AsyncServiceScope> _asyncScope;
                    /// <summary>
                    /// Initializes a new instance of the IFacade_Generated class.
                    /// </summary>
                    /// <param name = "serviceProvider">The service provider used for resolving dependencies.</param>
                    public IFacade_Generated(global::System.IServiceProvider serviceProvider)
                    {
                        _syncScope = new global::System.Lazy<global::Microsoft.Extensions.DependencyInjection.IServiceScope>(() => global::Microsoft.Extensions.DependencyInjection.ServiceProviderServiceExtensions.GetRequiredService<global::Microsoft.Extensions.DependencyInjection.IServiceScopeFactory>(serviceProvider).CreateScope());
                        _asyncScope = new global::System.Lazy<global::Microsoft.Extensions.DependencyInjection.AsyncServiceScope>(() => global::Microsoft.Extensions.DependencyInjection.ServiceProviderServiceExtensions.CreateAsyncScope(serviceProvider));
                    }

                    async global::System.Collections.Generic.IAsyncEnumerable<int> global::Demo.IFacade.Stream()
                    {
                        await foreach (var item in global::Microsoft.Extensions.DependencyInjection.ServiceProviderServiceExtensions.GetRequiredService<global::Demo.TestFacadeMethods>(_asyncScope.Value.ServiceProvider).Stream())
                        {
                            yield return item;
                        }
                    }

                    /// <summary>
                    /// Disposes the synchronous service scope.
                    /// </summary>
                    public void Dispose()
                    {
                        if (_syncDisposed || !_syncScope.IsValueCreated)
                            return;
                        _syncScope.Value.Dispose();
                        _syncDisposed = true;
                        global::System.GC.SuppressFinalize(this);
                    }

                    /// <summary>
                    /// Disposes the asynchronous service scope.
                    /// </summary>
                    /// <returns>A <see cref = "global::System.Threading.Tasks.ValueTask"/> representing the asynchronous operation.</returns>
                    public async global::System.Threading.Tasks.ValueTask DisposeAsync()
                    {
                        if (_asyncDisposed || !_asyncScope.IsValueCreated)
                            return;
                        await _asyncScope.Value.DisposeAsync().ConfigureAwait(false);
                        _asyncDisposed = true;
                        global::System.GC.SuppressFinalize(this);
                    }
                }
            }
            """;

        await VerifyAsync(
            source,
            ("Demo_IFacade_Generated.g.cs", expectedMainSource));
    }
#endif
    
    [Fact]
    public async Task Given_the_facade_attribute_defines_a_command_name_Should_rename_the_void_return_methods()
    {
        const string source =
            """
            using System;
            using Terminus;
            using System.Threading;

            namespace Demo
            {
                [FacadeOf(typeof(FacadeMethodAttribute), CommandName="Publish")]
                public partial interface IFacade;

                public class FacadeMethodAttribute : Attribute;

                public static class TestFacadeMethods
                {
                    [FacadeMethod]
                    public static void Hello(string world, CancellationToken cancellationToken)
                    {
                        Console.WriteLine($"hello {world}");
                    }
                }
            }
            """;

        const string expectedMainSource =
            """
            // <auto-generated/> Generated by Terminus FacadeGenerator
            #nullable enable
            namespace Demo
            {
                /// <summary>
                /// Facade interface delegating to: <see cref="Demo.TestFacadeMethods"/>
                /// </summary>
                [global::System.CodeDom.Compiler.GeneratedCode("Terminus.Generator", "1.0.0")]
                public partial interface IFacade
                {
                    /// <summary>
                    /// Delegates to:<br/>
                    /// <see cref="Demo.TestFacadeMethods.Hello(string, System.Threading.CancellationToken)"/>
                    /// </summary>
                    void Publish(string world, global::System.Threading.CancellationToken cancellationToken);
                }

                [global::System.CodeDom.Compiler.GeneratedCode("Terminus.Generator", "1.0.0")]
                [global::Terminus.FacadeImplementation(typeof(global::Demo.IFacade))]
                /// <summary>
                /// Facade implementation class delegating to: <see cref="Demo.TestFacadeMethods"/>
                /// </summary>
                public sealed class IFacade_Generated : global::Demo.IFacade
                {
                    private readonly global::System.IServiceProvider _serviceProvider;
                    /// <summary>
                    /// Initializes a new instance of the IFacade_Generated class.
                    /// </summary>
                    /// <param name = "serviceProvider">The service provider used for resolving dependencies.</param>
                    public IFacade_Generated(global::System.IServiceProvider serviceProvider)
                    {
                        _serviceProvider = serviceProvider;
                    }

                    void global::Demo.IFacade.Publish(string world, global::System.Threading.CancellationToken cancellationToken)
                    {
                        cancellationToken.ThrowIfCancellationRequested();
                        global::Demo.TestFacadeMethods.Hello(world, cancellationToken);
                    }
                }
            }
            """;

        await VerifyAsync(
            source,
            ("Demo_IFacade_Generated.g.cs", expectedMainSource));
    }
    
    [Fact]
    public async Task Given_the_facade_attribute_defines_an_async_command_name_Should_rename_the_task_return_methods()
    {
        const string source =
            """
            using System;
            using Terminus;
            using System.Threading;
            using System.Threading.Tasks;

            namespace Demo
            {
                [FacadeOf(typeof(FacadeMethodAttribute), AsyncCommandName="PublishAsync")]
                public partial interface IFacade;

                public class FacadeMethodAttribute : Attribute;

                public static class TestFacadeMethods
                {
                    [FacadeMethod]
                    public static Task HelloAsync(string world, CancellationToken cancellationToken)
                    {
                        Console.WriteLine($"hello {world}");
                        return Task.CompletedTask;
                    }
                }
            }
            """;

        const string expectedMainSource =
            """
            // <auto-generated/> Generated by Terminus FacadeGenerator
            #nullable enable
            namespace Demo
            {
                /// <summary>
                /// Facade interface delegating to: <see cref="Demo.TestFacadeMethods"/>
                /// </summary>
                [global::System.CodeDom.Compiler.GeneratedCode("Terminus.Generator", "1.0.0")]
                public partial interface IFacade
                {
                    /// <summary>
                    /// Delegates to:<br/>
                    /// <see cref="Demo.TestFacadeMethods.HelloAsync(string, System.Threading.CancellationToken)"/>
                    /// </summary>
                    global::System.Threading.Tasks.Task PublishAsync(string world, global::System.Threading.CancellationToken cancellationToken);
                }

                [global::System.CodeDom.Compiler.GeneratedCode("Terminus.Generator", "1.0.0")]
                [global::Terminus.FacadeImplementation(typeof(global::Demo.IFacade))]
                /// <summary>
                /// Facade implementation class delegating to: <see cref="Demo.TestFacadeMethods"/>
                /// </summary>
                public sealed class IFacade_Generated : global::Demo.IFacade
                {
                    private readonly global::System.IServiceProvider _serviceProvider;
                    /// <summary>
                    /// Initializes a new instance of the IFacade_Generated class.
                    /// </summary>
                    /// <param name = "serviceProvider">The service provider used for resolving dependencies.</param>
                    public IFacade_Generated(global::System.IServiceProvider serviceProvider)
                    {
                        _serviceProvider = serviceProvider;
                    }

                    async global::System.Threading.Tasks.Task global::Demo.IFacade.PublishAsync(string world, global::System.Threading.CancellationToken cancellationToken)
                    {
                        cancellationToken.ThrowIfCancellationRequested();
                        await global::Demo.TestFacadeMethods.HelloAsync(world, cancellationToken).ConfigureAwait(false);
                    }
                }
            }
            """;

        await VerifyAsync(
            source,
            ("Demo_IFacade_Generated.g.cs", expectedMainSource));
    }
    
    
    [Fact]
    public async Task Given_the_facade_attribute_defines_an_query_name_Should_rename_the_task_return_methods()
    {
        const string source =
            """
            using System;
            using Terminus;
            using System.Threading;

            namespace Demo
            {
                [FacadeOf(typeof(FacadeMethodAttribute), QueryName="Query")]
                public partial interface IFacade;

                public class FacadeMethodAttribute : Attribute;

                public static class TestFacadeMethods
                {
                    [FacadeMethod]
                    public static string Hello(string world, CancellationToken cancellationToken)
                    {
                        return world;
                    }
                }
            }
            """;

        const string expectedMainSource =
            """
            // <auto-generated/> Generated by Terminus FacadeGenerator
            #nullable enable
            namespace Demo
            {
                /// <summary>
                /// Facade interface delegating to: <see cref="Demo.TestFacadeMethods"/>
                /// </summary>
                [global::System.CodeDom.Compiler.GeneratedCode("Terminus.Generator", "1.0.0")]
                public partial interface IFacade
                {
                    /// <summary>
                    /// Delegates to:<br/>
                    /// <see cref="Demo.TestFacadeMethods.Hello(string, System.Threading.CancellationToken)"/>
                    /// </summary>
                    string Query(string world, global::System.Threading.CancellationToken cancellationToken);
                }

                [global::System.CodeDom.Compiler.GeneratedCode("Terminus.Generator", "1.0.0")]
                [global::Terminus.FacadeImplementation(typeof(global::Demo.IFacade))]
                /// <summary>
                /// Facade implementation class delegating to: <see cref="Demo.TestFacadeMethods"/>
                /// </summary>
                public sealed class IFacade_Generated : global::Demo.IFacade
                {
                    private readonly global::System.IServiceProvider _serviceProvider;
                    /// <summary>
                    /// Initializes a new instance of the IFacade_Generated class.
                    /// </summary>
                    /// <param name = "serviceProvider">The service provider used for resolving dependencies.</param>
                    public IFacade_Generated(global::System.IServiceProvider serviceProvider)
                    {
                        _serviceProvider = serviceProvider;
                    }

                    string global::Demo.IFacade.Query(string world, global::System.Threading.CancellationToken cancellationToken)
                    {
                        cancellationToken.ThrowIfCancellationRequested();
                        return global::Demo.TestFacadeMethods.Hello(world, cancellationToken);
                    }
                }
            }
            """;

        await VerifyAsync(
            source,
            ("Demo_IFacade_Generated.g.cs", expectedMainSource));
    }
    
    [Fact]
    public async Task Given_the_facade_attribute_defines_an_async_query_name_Should_rename_the_task_return_methods()
    {
        const string source =
            """
            using System;
            using Terminus;
            using System.Threading;
            using System.Threading.Tasks;

            namespace Demo
            {
                [FacadeOf(typeof(FacadeMethodAttribute), AsyncQueryName="QueryAsync")]
                public partial interface IFacade;

                public class FacadeMethodAttribute : Attribute;

                public static class TestFacadeMethods
                {
                    [FacadeMethod]
                    public static Task<string> HelloAsync(string world, CancellationToken cancellationToken)
                    {
                        return Task.FromResult(world);
                    }
                }
            }
            """;

        const string expectedMainSource =
            """
            // <auto-generated/> Generated by Terminus FacadeGenerator
            #nullable enable
            namespace Demo
            {
                /// <summary>
                /// Facade interface delegating to: <see cref="Demo.TestFacadeMethods"/>
                /// </summary>
                [global::System.CodeDom.Compiler.GeneratedCode("Terminus.Generator", "1.0.0")]
                public partial interface IFacade
                {
                    /// <summary>
                    /// Delegates to:<br/>
                    /// <see cref="Demo.TestFacadeMethods.HelloAsync(string, System.Threading.CancellationToken)"/>
                    /// </summary>
                    global::System.Threading.Tasks.Task<string> QueryAsync(string world, global::System.Threading.CancellationToken cancellationToken);
                }

                [global::System.CodeDom.Compiler.GeneratedCode("Terminus.Generator", "1.0.0")]
                [global::Terminus.FacadeImplementation(typeof(global::Demo.IFacade))]
                /// <summary>
                /// Facade implementation class delegating to: <see cref="Demo.TestFacadeMethods"/>
                /// </summary>
                public sealed class IFacade_Generated : global::Demo.IFacade
                {
                    private readonly global::System.IServiceProvider _serviceProvider;
                    /// <summary>
                    /// Initializes a new instance of the IFacade_Generated class.
                    /// </summary>
                    /// <param name = "serviceProvider">The service provider used for resolving dependencies.</param>
                    public IFacade_Generated(global::System.IServiceProvider serviceProvider)
                    {
                        _serviceProvider = serviceProvider;
                    }

                    async global::System.Threading.Tasks.Task<string> global::Demo.IFacade.QueryAsync(string world, global::System.Threading.CancellationToken cancellationToken)
                    {
                        cancellationToken.ThrowIfCancellationRequested();
                        return await global::Demo.TestFacadeMethods.HelloAsync(world, cancellationToken).ConfigureAwait(false);
                    }
                }
            }
            """;

        await VerifyAsync(
            source,
            ("Demo_IFacade_Generated.g.cs", expectedMainSource));
    }
    
    #if NETCOREAPP3_0_OR_GREATER || NETSTANDARD2_1_OR_GREATER
    [Fact]
    public async Task Given_the_facade_attribute_defines_an_async_stream_name_Should_rename_the_task_return_methods()
    {
        const string source =
            """
            using System.Collections.Generic;
            using Terminus;
            using System;

            namespace Demo
            {
                [FacadeOf(typeof(FacadeMethodAttribute), CreateScope=true, AsyncStreamName="StreamAsync")]
                public partial interface IFacade;

                public class FacadeMethodAttribute : Attribute;

                public class TestFacadeMethods
                {
                    [FacadeMethod]
                    public async IAsyncEnumerable<int> MyStream()
                    {
                        yield return 1;
                    }
                }
            }
            """;

        string expectedMainSource =
            """
            // <auto-generated/> Generated by Terminus FacadeGenerator
            #nullable enable
            namespace Demo
            {
                /// <summary>
                /// Facade interface delegating to: <see cref="Demo.TestFacadeMethods"/>
                /// </summary>
                [global::System.CodeDom.Compiler.GeneratedCode("Terminus.Generator", "1.0.0")]
                public partial interface IFacade
                {
                    /// <summary>
                    /// Delegates to:<br/>
                    /// <see cref="Demo.TestFacadeMethods.MyStream"/>
                    /// </summary>
                    global::System.Collections.Generic.IAsyncEnumerable<int> StreamAsync();
                }

                [global::System.CodeDom.Compiler.GeneratedCode("Terminus.Generator", "1.0.0")]
                [global::Terminus.FacadeImplementation(typeof(global::Demo.IFacade))]
                /// <summary>
                /// Facade implementation class delegating to: <see cref="Demo.TestFacadeMethods"/>
                /// </summary>
                public sealed class IFacade_Generated : global::Demo.IFacade, global::System.IDisposable, global::System.IAsyncDisposable
                {
                    private bool _syncDisposed;
                    private bool _asyncDisposed;
                    private readonly global::System.Lazy<global::Microsoft.Extensions.DependencyInjection.IServiceScope> _syncScope;
                    private readonly global::System.Lazy<global::Microsoft.Extensions.DependencyInjection.AsyncServiceScope> _asyncScope;
                    /// <summary>
                    /// Initializes a new instance of the IFacade_Generated class.
                    /// </summary>
                    /// <param name = "serviceProvider">The service provider used for resolving dependencies.</param>
                    public IFacade_Generated(global::System.IServiceProvider serviceProvider)
                    {
                        _syncScope = new global::System.Lazy<global::Microsoft.Extensions.DependencyInjection.IServiceScope>(() => global::Microsoft.Extensions.DependencyInjection.ServiceProviderServiceExtensions.GetRequiredService<global::Microsoft.Extensions.DependencyInjection.IServiceScopeFactory>(serviceProvider).CreateScope());
                        _asyncScope = new global::System.Lazy<global::Microsoft.Extensions.DependencyInjection.AsyncServiceScope>(() => global::Microsoft.Extensions.DependencyInjection.ServiceProviderServiceExtensions.CreateAsyncScope(serviceProvider));
                    }

                    async global::System.Collections.Generic.IAsyncEnumerable<int> global::Demo.IFacade.StreamAsync()
                    {
                        await foreach (var item in global::Microsoft.Extensions.DependencyInjection.ServiceProviderServiceExtensions.GetRequiredService<global::Demo.TestFacadeMethods>(_asyncScope.Value.ServiceProvider).MyStream())
                        {
                            yield return item;
                        }
                    }

                    /// <summary>
                    /// Disposes the synchronous service scope.
                    /// </summary>
                    public void Dispose()
                    {
                        if (_syncDisposed || !_syncScope.IsValueCreated)
                            return;
                        _syncScope.Value.Dispose();
                        _syncDisposed = true;
                        global::System.GC.SuppressFinalize(this);
                    }

                    /// <summary>
                    /// Disposes the asynchronous service scope.
                    /// </summary>
                    /// <returns>A <see cref = "global::System.Threading.Tasks.ValueTask"/> representing the asynchronous operation.</returns>
                    public async global::System.Threading.Tasks.ValueTask DisposeAsync()
                    {
                        if (_asyncDisposed || !_asyncScope.IsValueCreated)
                            return;
                        await _asyncScope.Value.DisposeAsync().ConfigureAwait(false);
                        _asyncDisposed = true;
                        global::System.GC.SuppressFinalize(this);
                    }
                }
            }
            """;

        await VerifyAsync(
            source,
            ("Demo_IFacade_Generated.g.cs", expectedMainSource));
    }
#endif

    [Fact]
    public async Task Given_attribute_on_class_Should_include_all_public_methods()
    {
        const string source =
            """
            using System;
            using Terminus;
            using System.Threading.Tasks;

            namespace Demo
            {
                [FacadeOf(typeof(FacadeMethodAttribute))]
                public partial interface IFacade;

                public class FacadeMethodAttribute : Attribute;

                [FacadeMethod]
                public class TestHandlers
                {
                    public void SyncMethod(string input)
                    {
                        Console.WriteLine(input);
                    }

                    public string QueryMethod(int id)
                    {
                        return $"Result {id}";
                    }

                    public async Task AsyncMethod()
                    {
                        await Task.CompletedTask;
                    }

                    private void PrivateMethod()
                    {
                        // Should be excluded
                    }
                }
            }
            """;

        const string expectedMainSource =
            """
            // <auto-generated/> Generated by Terminus FacadeGenerator
            #nullable enable
            namespace Demo
            {
                /// <summary>
                /// Facade interface delegating to: <see cref="Demo.TestHandlers"/>
                /// </summary>
                [global::System.CodeDom.Compiler.GeneratedCode("Terminus.Generator", "1.0.0")]
                public partial interface IFacade
                {
                    /// <summary>
                    /// Delegates to:<br/>
                    /// <see cref="Demo.TestHandlers.SyncMethod(string)"/>
                    /// </summary>
                    void SyncMethod(string input);
                    /// <summary>
                    /// Delegates to:<br/>
                    /// <see cref="Demo.TestHandlers.QueryMethod(int)"/>
                    /// </summary>
                    string QueryMethod(int id);
                    /// <summary>
                    /// Delegates to:<br/>
                    /// <see cref="Demo.TestHandlers.AsyncMethod"/>
                    /// </summary>
                    global::System.Threading.Tasks.Task AsyncMethod();
                }

                [global::System.CodeDom.Compiler.GeneratedCode("Terminus.Generator", "1.0.0")]
                [global::Terminus.FacadeImplementation(typeof(global::Demo.IFacade))]
                /// <summary>
                /// Facade implementation class delegating to: <see cref="Demo.TestHandlers"/>
                /// </summary>
                public sealed class IFacade_Generated : global::Demo.IFacade
                {
                    private readonly global::System.IServiceProvider _serviceProvider;
                    /// <summary>
                    /// Initializes a new instance of the IFacade_Generated class.
                    /// </summary>
                    /// <param name = "serviceProvider">The service provider used for resolving dependencies.</param>
                    public IFacade_Generated(global::System.IServiceProvider serviceProvider)
                    {
                        _serviceProvider = serviceProvider;
                    }

                    void global::Demo.IFacade.SyncMethod(string input)
                    {
                        global::Microsoft.Extensions.DependencyInjection.ServiceProviderServiceExtensions.GetRequiredService<global::Demo.TestHandlers>(_serviceProvider).SyncMethod(input);
                    }

                    string global::Demo.IFacade.QueryMethod(int id)
                    {
                        return global::Microsoft.Extensions.DependencyInjection.ServiceProviderServiceExtensions.GetRequiredService<global::Demo.TestHandlers>(_serviceProvider).QueryMethod(id);
                    }

                    async global::System.Threading.Tasks.Task global::Demo.IFacade.AsyncMethod()
                    {
                        await global::Microsoft.Extensions.DependencyInjection.ServiceProviderServiceExtensions.GetRequiredService<global::Demo.TestHandlers>(_serviceProvider).AsyncMethod().ConfigureAwait(false);
                    }
                }
            }
            """;

        await VerifyAsync(
            source,
            ("Demo_IFacade_Generated.g.cs", expectedMainSource));
    }

    [Fact]
    public async Task Given_mixed_class_and_method_attributes_Should_include_all_without_duplicates()
    {
        const string source =
            """
            using System;
            using Terminus;

            namespace Demo
            {
                [FacadeOf(typeof(FacadeMethodAttribute))]
                public partial interface IFacade;

                public class FacadeMethodAttribute : Attribute;

                [FacadeMethod]
                public class TestHandlers
                {
                    [FacadeMethod]
                    public void MethodWithBoth()
                    {
                        Console.WriteLine("Has both class and method attribute");
                    }

                    public void MethodFromClass()
                    {
                        Console.WriteLine("Only from class attribute");
                    }
                }
            }
            """;

        const string expectedMainSource =
            """
            // <auto-generated/> Generated by Terminus FacadeGenerator
            #nullable enable
            namespace Demo
            {
                /// <summary>
                /// Facade interface delegating to: <see cref="Demo.TestHandlers"/>
                /// </summary>
                [global::System.CodeDom.Compiler.GeneratedCode("Terminus.Generator", "1.0.0")]
                public partial interface IFacade
                {
                    /// <summary>
                    /// Delegates to:<br/>
                    /// <see cref="Demo.TestHandlers.MethodWithBoth"/>
                    /// </summary>
                    void MethodWithBoth();
                    /// <summary>
                    /// Delegates to:<br/>
                    /// <see cref="Demo.TestHandlers.MethodFromClass"/>
                    /// </summary>
                    void MethodFromClass();
                }

                [global::System.CodeDom.Compiler.GeneratedCode("Terminus.Generator", "1.0.0")]
                [global::Terminus.FacadeImplementation(typeof(global::Demo.IFacade))]
                /// <summary>
                /// Facade implementation class delegating to: <see cref="Demo.TestHandlers"/>
                /// </summary>
                public sealed class IFacade_Generated : global::Demo.IFacade
                {
                    private readonly global::System.IServiceProvider _serviceProvider;
                    /// <summary>
                    /// Initializes a new instance of the IFacade_Generated class.
                    /// </summary>
                    /// <param name = "serviceProvider">The service provider used for resolving dependencies.</param>
                    public IFacade_Generated(global::System.IServiceProvider serviceProvider)
                    {
                        _serviceProvider = serviceProvider;
                    }

                    void global::Demo.IFacade.MethodWithBoth()
                    {
                        global::Microsoft.Extensions.DependencyInjection.ServiceProviderServiceExtensions.GetRequiredService<global::Demo.TestHandlers>(_serviceProvider).MethodWithBoth();
                    }

                    void global::Demo.IFacade.MethodFromClass()
                    {
                        global::Microsoft.Extensions.DependencyInjection.ServiceProviderServiceExtensions.GetRequiredService<global::Demo.TestHandlers>(_serviceProvider).MethodFromClass();
                    }
                }
            }
            """;

        await VerifyAsync(
            source,
            ("Demo_IFacade_Generated.g.cs", expectedMainSource));
    }

    [Fact]
    public async Task Given_generic_facade_attribute_with_single_type_parameter_Should_generate_same_as_non_generic()
    {
        const string source =
            """
            using System;
            using Terminus;

            namespace Demo
            {
                [FacadeOf<FacadeMethodAttribute>]
                public partial interface IFacade;

                public class FacadeMethodAttribute : Attribute;

                public static class TestFacadeMethods
                {
                    [FacadeMethod]
                    public static void Hello(string world)
                    {
                        Console.WriteLine($"hello {world}");
                    }
                }
            }
            """;

        const string expectedMainSource =
            """
            // <auto-generated/> Generated by Terminus FacadeGenerator
            #nullable enable
            namespace Demo
            {
                /// <summary>
                /// Facade interface delegating to: <see cref="Demo.TestFacadeMethods"/>
                /// </summary>
                [global::System.CodeDom.Compiler.GeneratedCode("Terminus.Generator", "1.0.0")]
                public partial interface IFacade
                {
                    /// <summary>
                    /// Delegates to:<br/>
                    /// <see cref="Demo.TestFacadeMethods.Hello(string)"/>
                    /// </summary>
                    void Hello(string world);
                }

                [global::System.CodeDom.Compiler.GeneratedCode("Terminus.Generator", "1.0.0")]
                [global::Terminus.FacadeImplementation(typeof(global::Demo.IFacade))]
                /// <summary>
                /// Facade implementation class delegating to: <see cref="Demo.TestFacadeMethods"/>
                /// </summary>
                public sealed class IFacade_Generated : global::Demo.IFacade
                {
                    private readonly global::System.IServiceProvider _serviceProvider;
                    /// <summary>
                    /// Initializes a new instance of the IFacade_Generated class.
                    /// </summary>
                    /// <param name = "serviceProvider">The service provider used for resolving dependencies.</param>
                    public IFacade_Generated(global::System.IServiceProvider serviceProvider)
                    {
                        _serviceProvider = serviceProvider;
                    }

                    void global::Demo.IFacade.Hello(string world)
                    {
                        global::Demo.TestFacadeMethods.Hello(world);
                    }
                }
            }
            """;

        await VerifyAsync(
            source,
            ("Demo_IFacade_Generated.g.cs", expectedMainSource));
    }

    [Fact]
    public async Task Given_generic_facade_attribute_with_two_type_parameters_Should_generate_same_as_non_generic()
    {
        const string source =
            """
            using System;
            using Terminus;

            namespace Demo
            {
                [FacadeOf<CommandAttribute, QueryAttribute>]
                public partial interface IFacade;

                public class CommandAttribute : Attribute;
                public class QueryAttribute : Attribute;

                public static class TestFacadeMethods
                {
                    [Command]
                    public static void ExecuteCommand(string cmd)
                    {
                        Console.WriteLine($"Executing: {cmd}");
                    }

                    [Query]
                    public static string ExecuteQuery(int id)
                    {
                        return $"Result for {id}";
                    }
                }
            }
            """;

        const string expectedMainSource =
            """
            // <auto-generated/> Generated by Terminus FacadeGenerator
            #nullable enable
            namespace Demo
            {
                /// <summary>
                /// Facade interface delegating to: <see cref="Demo.TestFacadeMethods"/>
                /// </summary>
                [global::System.CodeDom.Compiler.GeneratedCode("Terminus.Generator", "1.0.0")]
                public partial interface IFacade
                {
                    /// <summary>
                    /// Delegates to:<br/>
                    /// <see cref="Demo.TestFacadeMethods.ExecuteCommand(string)"/>
                    /// </summary>
                    void ExecuteCommand(string cmd);
                    /// <summary>
                    /// Delegates to:<br/>
                    /// <see cref="Demo.TestFacadeMethods.ExecuteQuery(int)"/>
                    /// </summary>
                    string ExecuteQuery(int id);
                }

                [global::System.CodeDom.Compiler.GeneratedCode("Terminus.Generator", "1.0.0")]
                [global::Terminus.FacadeImplementation(typeof(global::Demo.IFacade))]
                /// <summary>
                /// Facade implementation class delegating to: <see cref="Demo.TestFacadeMethods"/>
                /// </summary>
                public sealed class IFacade_Generated : global::Demo.IFacade
                {
                    private readonly global::System.IServiceProvider _serviceProvider;
                    /// <summary>
                    /// Initializes a new instance of the IFacade_Generated class.
                    /// </summary>
                    /// <param name = "serviceProvider">The service provider used for resolving dependencies.</param>
                    public IFacade_Generated(global::System.IServiceProvider serviceProvider)
                    {
                        _serviceProvider = serviceProvider;
                    }

                    void global::Demo.IFacade.ExecuteCommand(string cmd)
                    {
                        global::Demo.TestFacadeMethods.ExecuteCommand(cmd);
                    }

                    string global::Demo.IFacade.ExecuteQuery(int id)
                    {
                        return global::Demo.TestFacadeMethods.ExecuteQuery(id);
                    }
                }
            }
            """;

        await VerifyAsync(
            source,
            ("Demo_IFacade_Generated.g.cs", expectedMainSource));
    }

    [Fact]
    public async Task Given_generic_facade_attribute_with_properties_Should_generate_correctly()
    {
        const string source =
            """
            using System;
            using Terminus;
            using System.Threading.Tasks;

            namespace Demo
            {
                [FacadeOf<HandlerAttribute>(
                    CommandName = "Execute",
                    QueryName = "Query",
                    CreateScope = true)]
                public partial interface IFacade;

                public class HandlerAttribute : Attribute;

                public class TestHandlers
                {
                    [Handler]
                    public void DoWork()
                    {
                    }

                    [Handler]
                    public string GetData()
                    {
                        return "data";
                    }

                    [Handler]
                    public async Task ProcessAsync()
                    {
                        await Task.CompletedTask;
                    }
                }
            }
            """;

        const string expectedMainSource =
            """
            // <auto-generated/> Generated by Terminus FacadeGenerator
            #nullable enable
            namespace Demo
            {
                /// <summary>
                /// Facade interface delegating to: <see cref="Demo.TestHandlers"/>
                /// </summary>
                [global::System.CodeDom.Compiler.GeneratedCode("Terminus.Generator", "1.0.0")]
                public partial interface IFacade
                {
                    /// <summary>
                    /// Delegates to:<br/>
                    /// <see cref="Demo.TestHandlers.DoWork"/>
                    /// </summary>
                    void Execute();
                    /// <summary>
                    /// Delegates to:<br/>
                    /// <see cref="Demo.TestHandlers.GetData"/>
                    /// </summary>
                    string Query();
                    /// <summary>
                    /// Delegates to:<br/>
                    /// <see cref="Demo.TestHandlers.ProcessAsync"/>
                    /// </summary>
                    global::System.Threading.Tasks.Task ProcessAsync();
                }

                [global::System.CodeDom.Compiler.GeneratedCode("Terminus.Generator", "1.0.0")]
                [global::Terminus.FacadeImplementation(typeof(global::Demo.IFacade))]
                /// <summary>
                /// Facade implementation class delegating to: <see cref="Demo.TestHandlers"/>
                /// </summary>
                public sealed class IFacade_Generated : global::Demo.IFacade, global::System.IDisposable, global::System.IAsyncDisposable
                {
                    private bool _syncDisposed;
                    private bool _asyncDisposed;
                    private readonly global::System.Lazy<global::Microsoft.Extensions.DependencyInjection.IServiceScope> _syncScope;
                    private readonly global::System.Lazy<global::Microsoft.Extensions.DependencyInjection.AsyncServiceScope> _asyncScope;
                    /// <summary>
                    /// Initializes a new instance of the IFacade_Generated class.
                    /// </summary>
                    /// <param name = "serviceProvider">The service provider used for resolving dependencies.</param>
                    public IFacade_Generated(global::System.IServiceProvider serviceProvider)
                    {
                        _syncScope = new global::System.Lazy<global::Microsoft.Extensions.DependencyInjection.IServiceScope>(() => global::Microsoft.Extensions.DependencyInjection.ServiceProviderServiceExtensions.GetRequiredService<global::Microsoft.Extensions.DependencyInjection.IServiceScopeFactory>(serviceProvider).CreateScope());
                        _asyncScope = new global::System.Lazy<global::Microsoft.Extensions.DependencyInjection.AsyncServiceScope>(() => global::Microsoft.Extensions.DependencyInjection.ServiceProviderServiceExtensions.CreateAsyncScope(serviceProvider));
                    }

                    void global::Demo.IFacade.Execute()
                    {
                        global::Microsoft.Extensions.DependencyInjection.ServiceProviderServiceExtensions.GetRequiredService<global::Demo.TestHandlers>(_syncScope.Value.ServiceProvider).DoWork();
                    }

                    string global::Demo.IFacade.Query()
                    {
                        return global::Microsoft.Extensions.DependencyInjection.ServiceProviderServiceExtensions.GetRequiredService<global::Demo.TestHandlers>(_syncScope.Value.ServiceProvider).GetData();
                    }

                    async global::System.Threading.Tasks.Task global::Demo.IFacade.ProcessAsync()
                    {
                        await global::Microsoft.Extensions.DependencyInjection.ServiceProviderServiceExtensions.GetRequiredService<global::Demo.TestHandlers>(_asyncScope.Value.ServiceProvider).ProcessAsync().ConfigureAwait(false);
                    }

                    /// <summary>
                    /// Disposes the synchronous service scope.
                    /// </summary>
                    public void Dispose()
                    {
                        if (_syncDisposed || !_syncScope.IsValueCreated)
                            return;
                        _syncScope.Value.Dispose();
                        _syncDisposed = true;
                        global::System.GC.SuppressFinalize(this);
                    }

                    /// <summary>
                    /// Disposes the asynchronous service scope.
                    /// </summary>
                    /// <returns>A <see cref = "global::System.Threading.Tasks.ValueTask"/> representing the asynchronous operation.</returns>
                    public async global::System.Threading.Tasks.ValueTask DisposeAsync()
                    {
                        if (_asyncDisposed || !_asyncScope.IsValueCreated)
                            return;
                        await _asyncScope.Value.DisposeAsync().ConfigureAwait(false);
                        _asyncDisposed = true;
                        global::System.GC.SuppressFinalize(this);
                    }
                }
            }
            """;

        await VerifyAsync(
            source,
            ("Demo_IFacade_Generated.g.cs", expectedMainSource));
    }

    [Fact]
    public async Task Given_generic_facade_attribute_with_eight_type_parameters_Should_generate_correctly()
    {
        const string source =
            """
            using System;
            using Terminus;

            namespace Demo
            {
                [FacadeOf<Attr1, Attr2, Attr3, Attr4, Attr5, Attr6, Attr7, Attr8>]
                public partial interface IFacade;

                public class Attr1 : Attribute;
                public class Attr2 : Attribute;
                public class Attr3 : Attribute;
                public class Attr4 : Attribute;
                public class Attr5 : Attribute;
                public class Attr6 : Attribute;
                public class Attr7 : Attribute;
                public class Attr8 : Attribute;

                public static class Methods
                {
                    [Attr1] public static void Method1() { }
                    [Attr2] public static void Method2() { }
                    [Attr3] public static void Method3() { }
                    [Attr4] public static void Method4() { }
                    [Attr5] public static void Method5() { }
                    [Attr6] public static void Method6() { }
                    [Attr7] public static void Method7() { }
                    [Attr8] public static void Method8() { }
                }
            }
            """;

        const string expectedMainSource =
            """
            // <auto-generated/> Generated by Terminus FacadeGenerator
            #nullable enable
            namespace Demo
            {
                /// <summary>
                /// Facade interface delegating to: <see cref="Demo.Methods"/>
                /// </summary>
                [global::System.CodeDom.Compiler.GeneratedCode("Terminus.Generator", "1.0.0")]
                public partial interface IFacade
                {
                    /// <summary>
                    /// Delegates to:<br/>
                    /// <see cref="Demo.Methods.Method1"/>
                    /// </summary>
                    void Method1();
                    /// <summary>
                    /// Delegates to:<br/>
                    /// <see cref="Demo.Methods.Method2"/>
                    /// </summary>
                    void Method2();
                    /// <summary>
                    /// Delegates to:<br/>
                    /// <see cref="Demo.Methods.Method3"/>
                    /// </summary>
                    void Method3();
                    /// <summary>
                    /// Delegates to:<br/>
                    /// <see cref="Demo.Methods.Method4"/>
                    /// </summary>
                    void Method4();
                    /// <summary>
                    /// Delegates to:<br/>
                    /// <see cref="Demo.Methods.Method5"/>
                    /// </summary>
                    void Method5();
                    /// <summary>
                    /// Delegates to:<br/>
                    /// <see cref="Demo.Methods.Method6"/>
                    /// </summary>
                    void Method6();
                    /// <summary>
                    /// Delegates to:<br/>
                    /// <see cref="Demo.Methods.Method7"/>
                    /// </summary>
                    void Method7();
                    /// <summary>
                    /// Delegates to:<br/>
                    /// <see cref="Demo.Methods.Method8"/>
                    /// </summary>
                    void Method8();
                }

                [global::System.CodeDom.Compiler.GeneratedCode("Terminus.Generator", "1.0.0")]
                [global::Terminus.FacadeImplementation(typeof(global::Demo.IFacade))]
                /// <summary>
                /// Facade implementation class delegating to: <see cref="Demo.Methods"/>
                /// </summary>
                public sealed class IFacade_Generated : global::Demo.IFacade
                {
                    private readonly global::System.IServiceProvider _serviceProvider;
                    /// <summary>
                    /// Initializes a new instance of the IFacade_Generated class.
                    /// </summary>
                    /// <param name = "serviceProvider">The service provider used for resolving dependencies.</param>
                    public IFacade_Generated(global::System.IServiceProvider serviceProvider)
                    {
                        _serviceProvider = serviceProvider;
                    }

                    void global::Demo.IFacade.Method1()
                    {
                        global::Demo.Methods.Method1();
                    }

                    void global::Demo.IFacade.Method2()
                    {
                        global::Demo.Methods.Method2();
                    }

                    void global::Demo.IFacade.Method3()
                    {
                        global::Demo.Methods.Method3();
                    }

                    void global::Demo.IFacade.Method4()
                    {
                        global::Demo.Methods.Method4();
                    }

                    void global::Demo.IFacade.Method5()
                    {
                        global::Demo.Methods.Method5();
                    }

                    void global::Demo.IFacade.Method6()
                    {
                        global::Demo.Methods.Method6();
                    }

                    void global::Demo.IFacade.Method7()
                    {
                        global::Demo.Methods.Method7();
                    }

                    void global::Demo.IFacade.Method8()
                    {
                        global::Demo.Methods.Method8();
                    }
                }
            }
            """;

        await VerifyAsync(
            source,
            ("Demo_IFacade_Generated.g.cs", expectedMainSource));
    }
}
