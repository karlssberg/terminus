using Microsoft.CodeAnalysis.Text;
using System.Text;
using Terminus.Generator.Tests.Unit.Generator.Infrastructure;

namespace Terminus.Generator.Tests.Unit.Generator;

public class FacadeGeneratorGenericTests : SourceGeneratorTestBase<FacadeGenerator>
{
    private const string SourceFilename = "Source.cs";

    [Fact]
    public async Task Given_generic_method_Should_generate_generic_facade_method()
    {
        const string source =
            """
            using System;
            using System.Threading.Tasks;
            using Terminus;

            namespace Demo
            {
                [FacadeOf(typeof(FacadeMethodAttribute))]
                public partial interface IFacade;
                
                public class FacadeMethodAttribute : Attribute;

                public class TestService
                {
                    [FacadeMethod]
                    public T Echo<T>(T value) => value;

                    [FacadeMethod]
                    public void Process<T1, T2>(T1 first, T2 second) { }
                    
                    [FacadeMethod]
                    public Task<T> GetAsync<T>(int id) => Task.FromResult(default(T)!);
                }
            }
            """;

        const string expectedInterface =
            """
            // <auto-generated/> Generated by Terminus FacadeGenerator
            #nullable enable
            namespace Demo
            {
                /// <summary>
                /// Facade interface delegating to: <see cref="Demo.TestService"/>
                /// </summary>
                [global::System.CodeDom.Compiler.GeneratedCode("Terminus.Generator", "1.0.0")]
                public partial interface IFacade
                {
                    /// <summary>
                    /// Delegates to:<br/>
                    /// <see cref="Demo.TestService.Echo(T)"/>
                    /// </summary>
                    T Echo<T>(T value);
                    /// <summary>
                    /// Delegates to:<br/>
                    /// <see cref="Demo.TestService.Process(T1, T2)"/>
                    /// </summary>
                    void Process<T1, T2>(T1 first, T2 second);
                    /// <summary>
                    /// Delegates to:<br/>
                    /// <see cref="Demo.TestService.GetAsync(int)"/>
                    /// </summary>
                    global::System.Threading.Tasks.Task<T> GetAsync<T>(int id);
                }

                [global::System.CodeDom.Compiler.GeneratedCode("Terminus.Generator", "1.0.0")]
                [global::Terminus.FacadeImplementation(typeof(global::Demo.IFacade))]
                public sealed class IFacade_Generated : global::Demo.IFacade
                {
                    private readonly global::System.IServiceProvider _serviceProvider;
                    public IFacade_Generated(global::System.IServiceProvider serviceProvider)
                    {
                        _serviceProvider = serviceProvider;
                    }

                    T global::Demo.IFacade.Echo<T>(T value)
                    {
                        return global::Microsoft.Extensions.DependencyInjection.ServiceProviderServiceExtensions.GetRequiredService<global::Demo.TestService>(_serviceProvider).Echo<T>(value);
                    }

                    void global::Demo.IFacade.Process<T1, T2>(T1 first, T2 second)
                    {
                        global::Microsoft.Extensions.DependencyInjection.ServiceProviderServiceExtensions.GetRequiredService<global::Demo.TestService>(_serviceProvider).Process<T1, T2>(first, second);
                    }

                    async global::System.Threading.Tasks.Task<T> global::Demo.IFacade.GetAsync<T>(int id)
                    {
                        return await global::Microsoft.Extensions.DependencyInjection.ServiceProviderServiceExtensions.GetRequiredService<global::Demo.TestService>(_serviceProvider).GetAsync<T>(id).ConfigureAwait(false);
                    }
                }
            }
            """;

        var test = new TerminusSourceGeneratorTest<FacadeGenerator>
        {
            TestState = { Sources = { source } }
        };

        test.TestState.GeneratedSources.Add((typeof(FacadeGenerator), "Demo_IFacade_Generated.g.cs", SourceText.From(expectedInterface, Encoding.UTF8)));

        await test.RunAsync();
    }

    [Fact]
    public async Task Given_generic_method_with_constraints_Should_generate_generic_facade_method_with_constraints()
    {
        const string source =
            """
            using System;
            using Terminus;

            namespace Demo
            {
                [FacadeOf(typeof(FacadeMethodAttribute))]
                public partial interface IFacade;
                
                public class FacadeMethodAttribute : Attribute;

                public interface IEntity { }

                public class TestService
                {
                    [FacadeMethod]
                    public void Save<T>(T item) where T : class, IEntity, new() { }
                }
            }
            """;

        const string expectedInterface =
            """
            // <auto-generated/> Generated by Terminus FacadeGenerator
            #nullable enable
            namespace Demo
            {
                /// <summary>
                /// Facade interface delegating to: <see cref="Demo.TestService"/>
                /// </summary>
                [global::System.CodeDom.Compiler.GeneratedCode("Terminus.Generator", "1.0.0")]
                public partial interface IFacade
                {
                    /// <summary>
                    /// Delegates to:<br/>
                    /// <see cref="Demo.TestService.Save(T)"/>
                    /// </summary>
                    void Save<T>(T item)
                        where T : class, global::Demo.IEntity, new();
                }

                [global::System.CodeDom.Compiler.GeneratedCode("Terminus.Generator", "1.0.0")]
                [global::Terminus.FacadeImplementation(typeof(global::Demo.IFacade))]
                public sealed class IFacade_Generated : global::Demo.IFacade
                {
                    private readonly global::System.IServiceProvider _serviceProvider;
                    public IFacade_Generated(global::System.IServiceProvider serviceProvider)
                    {
                        _serviceProvider = serviceProvider;
                    }

                    void global::Demo.IFacade.Save<T>(T item)
                    {
                        global::Microsoft.Extensions.DependencyInjection.ServiceProviderServiceExtensions.GetRequiredService<global::Demo.TestService>(_serviceProvider).Save<T>(item);
                    }
                }
            }
            """;

        var test = new TerminusSourceGeneratorTest<FacadeGenerator>
        {
            TestState = { Sources = { source } }
        };

        test.TestState.GeneratedSources.Add((typeof(FacadeGenerator), "Demo_IFacade_Generated.g.cs", SourceText.From(expectedInterface, Encoding.UTF8)));

        await test.RunAsync();
    }
}
