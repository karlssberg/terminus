using System.Text;
using Microsoft.CodeAnalysis.Text;
using Terminus.Generator.Tests.Unit.Generator.Infrastructure;

namespace Terminus.Generator.Tests.Unit.Generator;

public class GlobalNamespaceTests
{
    [Fact]
    public async Task Given_interface_in_global_namespace_Should_not_generate_namespace_block()
    {
        const string source =
            """
            using System;
            using Terminus;

            [FacadeOf(typeof(FacadeMethodAttribute))]
            public partial interface IGlobalFacade;

            public class FacadeMethodAttribute : Attribute;

            public class TestService
            {
                [FacadeMethod]
                public void Hello() => Console.WriteLine("Hello");
            }
            """;

        // We expect no namespace block
        const string expectedMainSource =
            """
            // <auto-generated/> Generated by Terminus FacadeGenerator
            #nullable enable
            [global::System.CodeDom.Compiler.GeneratedCode("Terminus.Generator", "1.0.0")]
            public partial interface IGlobalFacade
            {
                /// <summary>
                /// Delegates to:<br/>
                /// <see cref="TestService.Hello"/>
                /// </summary>
                void Hello();
            }

            [global::System.CodeDom.Compiler.GeneratedCode("Terminus.Generator", "1.0.0")]
            [global::Terminus.FacadeImplementation(typeof(global::IGlobalFacade))]
            public sealed class IGlobalFacade_Generated : global::IGlobalFacade
            {
                private readonly global::System.IServiceProvider _serviceProvider;
                public IGlobalFacade_Generated(global::System.IServiceProvider serviceProvider)
                {
                    _serviceProvider = serviceProvider;
                }

                void global::IGlobalFacade.Hello()
                {
                    global::Microsoft.Extensions.DependencyInjection.ServiceProviderServiceExtensions.GetRequiredService<global::TestService>(_serviceProvider).Hello();
                }
            }
            """;

        var test = new TerminusSourceGeneratorTest<FacadeGenerator>
        {
            TestState =
            {
                Sources = { source }
            }
        };

        test.TestState.GeneratedSources.Add((
            typeof(FacadeGenerator),
            "IGlobalFacade_Generated.g.cs",
            SourceText.From(expectedMainSource, Encoding.UTF8)));

        await test.RunAsync();
    }
}
