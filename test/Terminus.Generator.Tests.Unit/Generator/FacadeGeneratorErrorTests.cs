using Microsoft.CodeAnalysis.Testing;
namespace Terminus.Generator.Tests.Unit.Generator;

public class FacadeGeneratorErrorTests : SourceGeneratorTestBase<FacadeGenerator>
{
    private const string SourceFilename = "Source.cs";

    [Fact]
    public async Task Given_duplicate_entry_point_signatures_Should_aggregate_methods()
    {
        const string source =
            """
            using System;
            using Terminus;

            namespace Demo
            {
                [FacadeOf(typeof(FacadeMethodAttribute), CreateScope=true)]
                public partial interface IFacade;

                public class FacadeMethodAttribute : Attribute;

                public static class A
                {
                    [FacadeMethod]
                    public static void Hello(string world) { }
                }

                public static class B
                {
                    [FacadeMethod]
                    public static void Hello(string world) { }
                }
            }
            """;

        const string expected =
            """
            // <auto-generated/> Generated by Terminus FacadeGenerator
            #nullable enable
            namespace Demo
            {
                /// <summary>
                /// Facade interface delegating to:<br/>
                /// <see cref="Demo.A"/><br/>
                /// <see cref="Demo.B"/><br/>
                /// </summary>
                [global::System.CodeDom.Compiler.GeneratedCode("Terminus.Generator", "1.0.0")]
                public partial interface IFacade
                {
                    /// <summary>
                    /// Delegates to:<br/>
                    /// <see cref="Demo.A.Hello(string)"/><br/>
                    /// <see cref="Demo.B.Hello(string)"/>
                    /// </summary>
                    void Hello(string world);
                }

                [global::System.CodeDom.Compiler.GeneratedCode("Terminus.Generator", "1.0.0")]
                /// <summary>
                /// Facade implementation class delegating to:<br/>
                /// <see cref="Demo.A"/><br/>
                /// <see cref="Demo.B"/><br/>
                /// </summary>
                public sealed class IFacade_Generated : global::Demo.IFacade
                {
                    void global::Demo.IFacade.Hello(string world)
                    {
                        global::Demo.A.Hello(world);
                        global::Demo.B.Hello(world);
                    }
                }
            }
            """;

        await VerifyAsync(source, ("Demo_IFacade_Generated.g.cs", expected));
    }

    [Fact]
    public async Task Given_the_presence_of_ref_and_out_parameters_Should_fail_TM0002()
    {
        const string source =
            """
            using System;
            using Terminus;

            namespace Demo
            {
                [FacadeOf(typeof(FacadeMethodAttribute), CreateScope=true)]
                public partial interface IFacade;
            
                public class FacadeMethodAttribute : Attribute;

                public static class TestFacadeMethods
                {
                    [FacadeMethod]
                    public static void ProcessRef(ref int value) { }

                    [FacadeMethod]
                    public static void ProcessOut(out int value) { value = 0; }
                }
            }
            """;

        await VerifyAsync(
            source,
            expectedDiagnostics: [
                DiagnosticResult.CompilerError("TM0002")
                    .WithSpan(SourceFilename, 14, 39, 14, 42) // TestFacadeMethods.ProcessRef(ref int value) parameter 'value'
                    .WithArguments("ProcessRef", "value"),
                DiagnosticResult.CompilerError("TM0002")
                    .WithSpan(SourceFilename, 17, 39, 17, 42) // TestFacadeMethods.ProcessOut(out int value) parameter 'value'
                    .WithArguments("ProcessOut", "value"),
            ],
            sourceFilename: SourceFilename);
    }

    [Fact]
    public async Task Given_duplicate_entry_point_signatures_due_to_name_override_Should_aggregate_methods()
    {
        const string source =
            """
            using System;
            using Terminus;

            namespace Demo
            {
                [FacadeOf(typeof(FacadeMethodAttribute), CreateScope=true, CommandName="Execute")]
                public partial interface IFacade;

                public class FacadeMethodAttribute : Attribute;

                public static class A
                {
                    [FacadeMethod]
                    public static void Hello(string world) { }
                }

                public static class B
                {
                    [FacadeMethod]
                    public static void Goodbye(string world) { }
                }
            }
            """;

        const string expected =
            """
            // <auto-generated/> Generated by Terminus FacadeGenerator
            #nullable enable
            namespace Demo
            {
                /// <summary>
                /// Facade interface delegating to:<br/>
                /// <see cref="Demo.A"/><br/>
                /// <see cref="Demo.B"/><br/>
                /// </summary>
                [global::System.CodeDom.Compiler.GeneratedCode("Terminus.Generator", "1.0.0")]
                public partial interface IFacade
                {
                    /// <summary>
                    /// Delegates to:<br/>
                    /// <see cref="Demo.A.Hello(string)"/><br/>
                    /// <see cref="Demo.B.Goodbye(string)"/>
                    /// </summary>
                    void Execute(string world);
                }

                [global::System.CodeDom.Compiler.GeneratedCode("Terminus.Generator", "1.0.0")]
                /// <summary>
                /// Facade implementation class delegating to:<br/>
                /// <see cref="Demo.A"/><br/>
                /// <see cref="Demo.B"/><br/>
                /// </summary>
                public sealed class IFacade_Generated : global::Demo.IFacade
                {
                    void global::Demo.IFacade.Execute(string world)
                    {
                        global::Demo.A.Hello(world);
                        global::Demo.B.Goodbye(world);
                    }
                }
            }
            """;

        await VerifyAsync(source, ("Demo_IFacade_Generated.g.cs", expected));
    }

    [Fact]
    public async Task Given_invalid_CommandName_Should_fail_TM0004()
    {
        const string source =
            """
            using System;
            using Terminus;

            namespace Demo
            {
                [FacadeOf(typeof(FacadeMethodAttribute), CommandName="123Invalid")]
                public partial interface IFacade;

                public class FacadeMethodAttribute : Attribute;

                public static class TestFacadeMethods
                {
                    [FacadeMethod]
                    public static void Process() { }
                }
            }
            """;

        await VerifyAsync(
            source,
            expectedDiagnostics: [
                DiagnosticResult.CompilerError("TM0004")
                    .WithSpan(SourceFilename, 6, 59, 6, 69)
                    .WithArguments("123Invalid", "CommandName", "IFacade"),
            ],
            sourceFilename: SourceFilename);
    }

    [Fact]
    public async Task Given_invalid_AsyncQueryName_Should_fail_TM0004()
    {
        const string source =
            """
            using System;
            using System.Threading.Tasks;
            using Terminus;

            namespace Demo
            {
                [FacadeOf(typeof(FacadeMethodAttribute), AsyncQueryName="Query-Name")]
                public partial interface IFacade;

                public class FacadeMethodAttribute : Attribute;

                public static class TestFacadeMethods
                {
                    [FacadeMethod]
                    public static Task<int> GetValueAsync() => Task.FromResult(42);
                }
            }
            """;

        await VerifyAsync(
            source,
            expectedDiagnostics: [
                DiagnosticResult.CompilerError("TM0004")
                    .WithSpan(SourceFilename, 7, 62, 7, 72)
                    .WithArguments("Query-Name", "AsyncQueryName", "IFacade"),
            ],
            sourceFilename: SourceFilename);
    }

    [Fact]
    public async Task Given_invalid_method_name_When_raw_string_literals_are_used_Should_fail_TM0004()
    {
        const string source =
            """"
            using System;
            using System.Threading.Tasks;
            using Terminus;

            namespace Demo
            {
                [FacadeOf(typeof(FacadeMethodAttribute), AsyncQueryName="""Query-Name""")]
                public partial interface IFacade;

                public class FacadeMethodAttribute : Attribute;

                public static class TestFacadeMethods
                {
                    [FacadeMethod]
                    public static Task<int> GetValueAsync() => Task.FromResult(42);
                }
            }
            """";

        await VerifyAsync(
            source,
            expectedDiagnostics: [
                DiagnosticResult.CompilerError("TM0004")
                    .WithSpan(SourceFilename, 7, 64, 7, 74)
                    .WithArguments("Query-Name", "AsyncQueryName", "IFacade"),
            ],
            sourceFilename: SourceFilename);
    }
    

    [Fact]
    public async Task Given_invalid_method_name_When_raw_string_interpolated_literals_are_used_Should_fail_TM0004()
    {
        const string source =
            """"
            using System;
            using System.Threading.Tasks;
            using Terminus;

            namespace Demo
            {
                [FacadeOf(typeof(FacadeMethodAttribute), AsyncQueryName=$"Query-Name")]
                public partial interface IFacade;

                public class FacadeMethodAttribute : Attribute;

                public static class TestFacadeMethods
                {
                    [FacadeMethod]
                    public static Task<int> GetValueAsync() => Task.FromResult(42);
                }
            }
            """";

        await VerifyAsync(
            source,
            expectedDiagnostics: [
                DiagnosticResult.CompilerError("TM0004")
                    .WithSpan(SourceFilename, 7, 63, 7, 73)
                    .WithArguments("Query-Name", "AsyncQueryName", "IFacade"),
            ],
            sourceFilename: SourceFilename);
    }

    [Fact]
    public async Task Given_multiple_invalid_method_names_Should_fail_TM0004_for_each()
    {
        const string source =
            """
            using System;
            using System.Collections.Generic;
            using System.Threading.Tasks;
            using Terminus;

            namespace Demo
            {
                [FacadeOf(typeof(FacadeMethodAttribute),
                    CommandName="Hello World",
                    QueryName="",
                    AsyncStreamName="Stream.Name")]
                public partial interface IFacade;

                public class FacadeMethodAttribute : Attribute;
            }
            """;

        await VerifyAsync(
            source,
            expectedDiagnostics: [
                DiagnosticResult.CompilerError("TM0004")
                    .WithSpan(SourceFilename, 9, 22, 9, 33)
                    .WithArguments("Hello World", "CommandName", "IFacade"),
                DiagnosticResult.CompilerError("TM0004")
                    .WithSpan(SourceFilename, 10, 20, 10, 20)
                    .WithArguments("", "QueryName", "IFacade"),
                DiagnosticResult.CompilerError("TM0004")
                    .WithSpan(SourceFilename, 11, 26, 11, 37)
                    .WithArguments("Stream.Name", "AsyncStreamName", "IFacade"),
            ],
            sourceFilename: SourceFilename);
    }

    [Fact]
    public async Task Given_valid_custom_method_names_Should_generate_successfully()
    {
        const string source =
            """
            using System;
            using Terminus;

            namespace Demo
            {
                [FacadeOf(typeof(FacadeMethodAttribute),
                    CommandName="Execute",
                    QueryName="Query",
                    AsyncCommandName="ExecuteAsync")]
                public partial interface IFacade;

                public class FacadeMethodAttribute : Attribute;

                public static class TestFacadeMethods
                {
                    [FacadeMethod]
                    public static void Process() { }
                }
            }
            """;

        const string expected =
            """
            // <auto-generated/> Generated by Terminus FacadeGenerator
            #nullable enable
            namespace Demo
            {
                /// <summary>
                /// Facade interface delegating to: <see cref="Demo.TestFacadeMethods"/>
                /// </summary>
                [global::System.CodeDom.Compiler.GeneratedCode("Terminus.Generator", "1.0.0")]
                public partial interface IFacade
                {
                    /// <summary>
                    /// Delegates to:<br/>
                    /// <see cref="Demo.TestFacadeMethods.Process"/>
                    /// </summary>
                    void Execute();
                }

                [global::System.CodeDom.Compiler.GeneratedCode("Terminus.Generator", "1.0.0")]
                [global::Terminus.FacadeImplementation(typeof(global::Demo.IFacade))]
                /// <summary>
                /// Facade implementation class delegating to: <see cref="Demo.TestFacadeMethods"/>
                /// </summary>
                public sealed class IFacade_Generated : global::Demo.IFacade
                {
                    private readonly global::System.IServiceProvider _serviceProvider;
                    /// <summary>
                    /// Initializes a new instance of the IFacade_Generated class.
                    /// </summary>
                    /// <param name = "serviceProvider">The service provider used for resolving dependencies.</param>
                    public IFacade_Generated(global::System.IServiceProvider serviceProvider)
                    {
                        _serviceProvider = serviceProvider;
                    }

                    void global::Demo.IFacade.Execute()
                    {
                        global::Demo.TestFacadeMethods.Process();
                    }
                }
            }
            """;

        await VerifyAsync(source, ("Demo_IFacade_Generated.g.cs", expected));
    }

    [Fact]
    public async Task Given_method_name_conflicts_with_property_name_Should_fail_TM0006()
    {
        const string source =
            """
            using System;
            using Terminus;

            namespace Demo
            {
                [FacadeOf(typeof(FacadeMethodAttribute))]
                public partial interface IFacade;

                public class FacadeMethodAttribute : Attribute;

                public static class TestFacadeMethods
                {
                    [FacadeMethod]
                    public static void Status() { }
                }

                public static class TestFacadeProperties
                {
                    [FacadeMethod]
                    public static string Status => "active";
                }
            }
            """;

        await VerifyAsync(
            source,
            expectedDiagnostics: [
                DiagnosticResult.CompilerError("TM0006")
                    .WithSpan(SourceFilename, 14, 28, 14, 34)
                    .WithArguments("Status", "Status", "IFacade"),
            ],
            sourceFilename: SourceFilename);
    }

    [Fact]
    public async Task Given_method_renamed_to_property_name_via_naming_strategy_Should_fail_TM0006()
    {
        const string source =
            """
            using System;
            using Terminus;

            namespace Demo
            {
                [FacadeOf(typeof(FacadeMethodAttribute), CommandName="Status")]
                public partial interface IFacade;

                public class FacadeMethodAttribute : Attribute;

                public static class TestFacadeMethods
                {
                    [FacadeMethod]
                    public static void Process() { }
                }

                public static class TestFacadeProperties
                {
                    [FacadeMethod]
                    public static string Status => "active";
                }
            }
            """;

        await VerifyAsync(
            source,
            expectedDiagnostics: [
                DiagnosticResult.CompilerError("TM0006")
                    .WithSpan(SourceFilename, 14, 28, 14, 35)
                    .WithArguments("Status", "Status", "IFacade"),
            ],
            sourceFilename: SourceFilename);
    }

    [Fact]
    public async Task Given_methods_with_same_signature_but_incompatible_return_types_Should_fail_TM0007()
    {
        const string source =
            """
            using System;
            using System.Threading.Tasks;
            using Terminus;

            namespace Demo
            {
                [FacadeOf(typeof(FacadeMethodAttribute))]
                public partial interface IFacade;

                public class FacadeMethodAttribute : Attribute;

                public static class HandlerA
                {
                    [FacadeMethod]
                    public static void Process(string data) { }
                }

                public static class HandlerB
                {
                    [FacadeMethod]
                    public static string Process(string data) => data;
                }
            }
            """;

        await VerifyAsync(
            source,
            expectedDiagnostics: [
                DiagnosticResult.CompilerError("TM0007")
                    .WithSpan(SourceFilename, 21, 30, 21, 37)
                    .WithArguments("Process(string)", "void", "T"),
            ],
            sourceFilename: SourceFilename);
    }

    [Fact]
    public async Task Given_Task_and_ValueTask_return_types_Should_allow_aggregation()
    {
        const string source =
            """
            using System;
            using System.Threading.Tasks;
            using Terminus;

            namespace Demo
            {
                [FacadeOf(typeof(FacadeMethodAttribute))]
                public partial interface IFacade;

                public class FacadeMethodAttribute : Attribute;

                public static class HandlerA
                {
                    [FacadeMethod]
                    public static Task ProcessAsync(string data) => Task.CompletedTask;
                }

                public static class HandlerB
                {
                    [FacadeMethod]
                    public static ValueTask ProcessAsync(string data) => default;
                }
            }
            """;

        const string expected =
            """
            // <auto-generated/> Generated by Terminus FacadeGenerator
            #nullable enable
            namespace Demo
            {
                /// <summary>
                /// Facade interface delegating to:<br/>
                /// <see cref="Demo.HandlerA"/><br/>
                /// <see cref="Demo.HandlerB"/><br/>
                /// </summary>
                [global::System.CodeDom.Compiler.GeneratedCode("Terminus.Generator", "1.0.0")]
                public partial interface IFacade
                {
                    /// <summary>
                    /// Delegates to:<br/>
                    /// <see cref="Demo.HandlerA.ProcessAsync(string)"/><br/>
                    /// <see cref="Demo.HandlerB.ProcessAsync(string)"/>
                    /// </summary>
                    global::System.Threading.Tasks.Task ProcessAsync(string data);
                }

                [global::System.CodeDom.Compiler.GeneratedCode("Terminus.Generator", "1.0.0")]
                [global::Terminus.FacadeImplementation(typeof(global::Demo.IFacade))]
                /// <summary>
                /// Facade implementation class delegating to:<br/>
                /// <see cref="Demo.HandlerA"/><br/>
                /// <see cref="Demo.HandlerB"/><br/>
                /// </summary>
                public sealed class IFacade_Generated : global::Demo.IFacade
                {
                    private readonly global::System.IServiceProvider _serviceProvider;
                    /// <summary>
                    /// Initializes a new instance of the IFacade_Generated class.
                    /// </summary>
                    /// <param name = "serviceProvider">The service provider used for resolving dependencies.</param>
                    public IFacade_Generated(global::System.IServiceProvider serviceProvider)
                    {
                        _serviceProvider = serviceProvider;
                    }

                    async global::System.Threading.Tasks.Task global::Demo.IFacade.ProcessAsync(string data)
                    {
                        await global::Demo.HandlerA.ProcessAsync(data).ConfigureAwait(false);
                        await global::Demo.HandlerB.ProcessAsync(data).ConfigureAwait(false);
                    }
                }
            }
            """;

        await VerifyAsync(source, ("Demo_IFacade_Generated.g.cs", expected));
    }

    [Fact]
    public async Task Given_Task_and_TaskWithResult_Should_fail_TM0007()
    {
        const string source =
            """
            using System;
            using System.Threading.Tasks;
            using Terminus;

            namespace Demo
            {
                [FacadeOf(typeof(FacadeMethodAttribute))]
                public partial interface IFacade;

                public class FacadeMethodAttribute : Attribute;

                public static class HandlerA
                {
                    [FacadeMethod]
                    public static Task ProcessAsync(string data) => Task.CompletedTask;
                }

                public static class HandlerB
                {
                    [FacadeMethod]
                    public static Task<int> ProcessAsync(string data) => Task.FromResult(42);
                }
            }
            """;

        await VerifyAsync(
            source,
            expectedDiagnostics: [
                DiagnosticResult.CompilerError("TM0007")
                    .WithSpan(SourceFilename, 21, 33, 21, 45)
                    .WithArguments("ProcessAsync(string)", "Task", "Task<T>"),
            ],
            sourceFilename: SourceFilename);
    }
}
