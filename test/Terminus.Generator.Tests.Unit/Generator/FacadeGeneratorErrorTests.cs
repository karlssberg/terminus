using Microsoft.CodeAnalysis.Testing;
namespace Terminus.Generator.Tests.Unit.Generator;

public class FacadeGeneratorErrorTests : SourceGeneratorTestBase<FacadeGenerator>
{
    private const string SourceFilename = "Source.cs";

    [Fact]
    public async Task Given_duplicate_entry_point_signatures_Should_aggregate_methods()
    {
        const string source =
            """
            using System;
            using Terminus;

            namespace Demo
            {
                [FacadeOf(typeof(FacadeMethodAttribute), Scoped=true)]
                public partial interface IFacade;

                public class FacadeMethodAttribute : Attribute;

                public static class A
                {
                    [FacadeMethod]
                    public static void Hello(string world) { }
                }

                public static class B
                {
                    [FacadeMethod]
                    public static void Hello(string world) { }
                }
            }
            """;

        const string expected =
            """
            // <auto-generated/> Generated by Terminus FacadeGenerator
            #nullable enable
            namespace Demo
            {
                /// <summary>
                /// Facade interface delegating to:<br/>
                /// <see cref="Demo.A"/><br/>
                /// <see cref="Demo.B"/><br/>
                /// </summary>
                [global::System.CodeDom.Compiler.GeneratedCode("Terminus.Generator", "1.0.0")]
                public partial interface IFacade
                {
                    /// <summary>
                    /// Delegates to:<br/>
                    /// <see cref="Demo.A.Hello(string)"/><br/>
                    /// <see cref="Demo.B.Hello(string)"/>
                    /// </summary>
                    void Hello(string world);
                }

                [global::System.CodeDom.Compiler.GeneratedCode("Terminus.Generator", "1.0.0")]
                /// <summary>
                /// Facade implementation class delegating to:<br/>
                /// <see cref="Demo.A"/><br/>
                /// <see cref="Demo.B"/><br/>
                /// </summary>
                public sealed class IFacade_Generated : global::Demo.IFacade
                {
                    void global::Demo.IFacade.Hello(string world)
                    {
                        global::Demo.A.Hello(world);
                        global::Demo.B.Hello(world);
                    }
                }
            }
            """;

        await VerifyAsync(source, ("Demo_IFacade_Generated.g.cs", expected));
    }

    [Fact]
    public async Task Given_the_presence_of_ref_and_out_parameters_Should_fail_TM0002()
    {
        const string source =
            """
            using System;
            using Terminus;

            namespace Demo
            {
                [FacadeOf(typeof(FacadeMethodAttribute), Scoped=true)]
                public partial interface IFacade;
            
                public class FacadeMethodAttribute : Attribute;

                public static class TestFacadeMethods
                {
                    [FacadeMethod]
                    public static void ProcessRef(ref int value) { }

                    [FacadeMethod]
                    public static void ProcessOut(out int value) { value = 0; }
                }
            }
            """;

        await VerifyAsync(
            source,
            expectedDiagnostics: [
                DiagnosticResult.CompilerError("TM0002")
                    .WithSpan(SourceFilename, 14, 47, 14, 52) // TestFacadeMethods.ProcessRef(ref int value) parameter 'value'
                    .WithArguments("ProcessRef", "value"),
                DiagnosticResult.CompilerError("TM0002")
                    .WithSpan(SourceFilename, 17, 47, 17, 52) // TestFacadeMethods.ProcessOut(out int value) parameter 'value'
                    .WithArguments("ProcessOut", "value"),
            ],
            sourceFilename: SourceFilename);
    }

    [Fact]
    public async Task Given_duplicate_entry_point_signatures_due_to_name_override_Should_aggregate_methods()
    {
        const string source =
            """
            using System;
            using Terminus;

            namespace Demo
            {
                [FacadeOf(typeof(FacadeMethodAttribute), Scoped=true, CommandName="Execute")]
                public partial interface IFacade;

                public class FacadeMethodAttribute : Attribute;

                public static class A
                {
                    [FacadeMethod]
                    public static void Hello(string world) { }
                }

                public static class B
                {
                    [FacadeMethod]
                    public static void Goodbye(string world) { }
                }
            }
            """;

        const string expected =
            """
            // <auto-generated/> Generated by Terminus FacadeGenerator
            #nullable enable
            namespace Demo
            {
                /// <summary>
                /// Facade interface delegating to:<br/>
                /// <see cref="Demo.A"/><br/>
                /// <see cref="Demo.B"/><br/>
                /// </summary>
                [global::System.CodeDom.Compiler.GeneratedCode("Terminus.Generator", "1.0.0")]
                public partial interface IFacade
                {
                    /// <summary>
                    /// Delegates to:<br/>
                    /// <see cref="Demo.A.Hello(string)"/><br/>
                    /// <see cref="Demo.B.Goodbye(string)"/>
                    /// </summary>
                    void Execute(string world);
                }

                [global::System.CodeDom.Compiler.GeneratedCode("Terminus.Generator", "1.0.0")]
                /// <summary>
                /// Facade implementation class delegating to:<br/>
                /// <see cref="Demo.A"/><br/>
                /// <see cref="Demo.B"/><br/>
                /// </summary>
                public sealed class IFacade_Generated : global::Demo.IFacade
                {
                    void global::Demo.IFacade.Execute(string world)
                    {
                        global::Demo.A.Hello(world);
                        global::Demo.B.Goodbye(world);
                    }
                }
            }
            """;

        await VerifyAsync(source, ("Demo_IFacade_Generated.g.cs", expected));
    }
}
